<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>FortuneAI式 17タイプ診断</title>

  <style>
    :root{
      --bg0:#070b1a;
      --bg1:#0b1231;

      --card: rgba(255,255,255,.06);
      --line: rgba(255,255,255,.14);
      --text:#eaf0ff;

      --accent1:#7c4dff;
      --accent2:#cfa76e;
      --accent3:#43d3ff;

      --shadow: 0 18px 60px rgba(0,0,0,.38);
      --r: 18px;

      --safeBottom: env(safe-area-inset-bottom, 0px);
      --safeTop: env(safe-area-inset-top, 0px);

      /* JSで実測して入れる（質問画面のスクロール撲滅用） */
      --headerH: 110px;
      --bottomH: 86px;

      /* ★重要：スマホで右予約すると文字が潰れて「ぐちゃぐちゃ」になるのでデフォ0 */
      --mapReserve: 0px;

      /* ★追加：ミニマップを上に上げる量（ここを調整） */
      --miniMapLift: 220px;
    }

    *{box-sizing:border-box}
    html, body{height:100%; overscroll-behavior:none; -webkit-text-size-adjust:100%;}
    body{
      margin:0;
      color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Sans", "Yu Gothic", sans-serif;
      background:
        radial-gradient(1200px 650px at 15% 5%, color-mix(in oklab, var(--accent1) 35%, transparent), transparent 62%),
        radial-gradient(900px 540px at 85% 25%, color-mix(in oklab, var(--accent2) 26%, transparent), transparent 62%),
        radial-gradient(900px 540px at 65% 85%, color-mix(in oklab, var(--accent3) 18%, transparent), transparent 62%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
      touch-action: pan-y;
    }

    /* 質問画面だけ「ページスクロールなし」 */
    body.isQuestions{
      height: 100svh;
      overflow: hidden;
      touch-action: manipulation;
    }

    input, select, textarea{max-width:100%;}
    /* iOSでフォームが変に伸びる/ズームするのを抑える */
    input, select, textarea{ font-size:16px; }

    .wrap{
      max-width:1180px;
      margin:0 auto;
      padding: 14px 14px calc(96px + var(--safeBottom));
    }

    /* 質問画面は viewport に収める（縦スクロール禁止） */
    body.isQuestions .wrap{
      height: calc(100svh - var(--headerH) - var(--bottomH));
      padding: 10px 14px 0;
      padding-right: 14px;           /* ★スマホは右予約しない（崩壊原因） */
      overflow: hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    /* タブレット以上だけ右にミニマップ分の余白を確保（被りゼロ） */
    @media (min-width: 720px){
      :root{ --mapReserve: 170px; }
      body.isQuestions .wrap{ padding-right: calc(14px + var(--mapReserve)); }
    }

    /* ===== Header (スマホ2段化で被りゼロ) ===== */
    .topbar{
      position:sticky; top:0; z-index:80;
      padding-top: var(--safeTop);
      background: linear-gradient(180deg, rgba(7,11,26,.94), rgba(11,18,49,.70));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .topbarInner{
      max-width:1180px;
      margin:0 auto;
      padding: 12px 14px 12px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      min-width:0;
    }
    .brand{display:flex; gap:12px; align-items:center; min-width:0;}
    .orb{
      width:44px; height:44px; border-radius:999px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.92), rgba(255,255,255,.10) 42%, rgba(124,77,255,.28) 72%, rgba(207,167,110,.18));
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 0 26px color-mix(in oklab, var(--accent1) 28%, transparent),
                  0 0 18px color-mix(in oklab, var(--accent2) 18%, transparent);
      flex: 0 0 auto;
    }
    .title{font-size:14px; letter-spacing:.06em; margin:0; line-height:1.2;}
    .subtitle{
      font-size:12px; opacity:.86; margin-top:4px; line-height:1.35;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: min(560px, 58vw);
    }

    .meter{
      width: min(520px, 52vw);
      min-width: 220px;
      display:flex; align-items:center; gap:10px;
      justify-content:flex-end;
      min-width:0;
    }
    .meterText{font-size:12px; opacity:.92; min-width:72px; text-align:right; white-space:nowrap;}
    .waterBar{
      position:relative; height:16px; width:100%;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.14);
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.08);
    }
    .waterFill{
      position:absolute; inset:0 auto 0 0; width:0%;
      border-radius:999px;
      background:
        linear-gradient(90deg,
          color-mix(in oklab, var(--accent1) 90%, white 10%),
          color-mix(in oklab, var(--accent3) 70%, white 10%),
          color-mix(in oklab, var(--accent2) 85%, white 10%));
      filter:saturate(1.05);
      transition: width .30s ease;
      overflow:hidden;
    }
    .waterFill::before{
      content:"";
      position:absolute; inset:-10px -60px -10px -60px;
      background:
        radial-gradient(18px 10px at 20px 18px, rgba(255,255,255,.34), rgba(255,255,255,0) 70%),
        radial-gradient(22px 12px at 60px 26px, rgba(255,255,255,.22), rgba(255,255,255,0) 72%),
        radial-gradient(18px 10px at 100px 18px, rgba(255,255,255,.30), rgba(255,255,255,0) 70%);
      opacity:.50;
      animation: waveMove 2.4s linear infinite;
      mix-blend-mode: screen;
      pointer-events:none;
    }
    @keyframes waveMove{0%{transform:translateX(0)}100%{transform:translateX(110px)}}
    .waterFill .sparkles{
      position:absolute; inset:-30px -60px -30px -60px;
      background:
        radial-gradient(2px 2px at 14% 44%, rgba(255,255,255,.95), rgba(255,255,255,0) 60%),
        radial-gradient(1.5px 1.5px at 28% 62%, rgba(255,255,255,.88), rgba(255,255,255,0) 60%),
        radial-gradient(2px 2px at 42% 32%, rgba(255,255,255,.82), rgba(255,255,255,0) 60%),
        radial-gradient(1.2px 1.2px at 58% 52%, rgba(255,255,255,.80), rgba(255,255,255,0) 60%),
        radial-gradient(2px 2px at 72% 38%, rgba(255,255,255,.90), rgba(255,255,255,0) 60%),
        radial-gradient(1.6px 1.6px at 84% 58%, rgba(255,255,255,.84), rgba(255,255,255,0) 60%);
      opacity:.55;
      animation: sparkleDrift 3.2s linear infinite;
      mix-blend-mode: screen;
      pointer-events:none;
    }
    @keyframes sparkleDrift{
      0%{ transform: translateX(-20px) translateY(0px); filter: blur(.0px); }
      50%{ transform: translateX(20px) translateY(-6px); filter: blur(.2px); }
      100%{ transform: translateX(60px) translateY(0px); filter: blur(.0px); }
    }

    @media(max-width:560px){
      .topbarInner{flex-direction:column; align-items:stretch; gap:10px;}
      .brand{width:100%;}
      .subtitle{max-width:100%;}
      .meter{width:100%; min-width:0; justify-content:space-between;}
      .meterText{min-width:64px;}
    }

    .card{
      margin-top:14px;
      border:1px solid var(--line);
      background: var(--card);
      border-radius: var(--r);
      padding: 16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
    }

    body.isQuestions #viewQuestions.card{
      flex: 1;
      min-height:0;
      margin-top: 10px;
      padding: 0;
      background: transparent;
      border: none;
      box-shadow: none;
      backdrop-filter: none;
      display:flex;
    }

    .h1{font-size:18px; margin:0 0 8px; letter-spacing:.05em; line-height:1.25;}
    .lead{margin:0; font-size:13px; opacity:.88; line-height:1.75;}
    .muted{opacity:.84}
    .small{font-size:12px}
    .sep{height:1px; background: rgba(255,255,255,.10); margin: 12px 0;}

    .pillRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.04);
      font-size:12px; opacity:.95;
    }

    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; align-items:center;}
    .btn{
      appearance:none; border:none;
      padding: 12px 14px; border-radius: 14px;
      cursor:pointer; color: var(--text);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      transition: transform .08s ease, border-color .2s ease, background .2s ease, filter .2s ease;
      user-select:none; -webkit-tap-highlight-color: transparent;
      white-space: nowrap;
    }
    .btn:hover{border-color: rgba(255,255,255,.22);}
    .btn:active{transform: translateY(1px) scale(.995);}
    .btn.primary{
      background: linear-gradient(90deg,
        color-mix(in oklab, var(--accent1) 85%, black 10%),
        color-mix(in oklab, var(--accent2) 80%, black 10%));
      border-color: rgba(255,255,255,.18);
      filter: saturate(1.08);
    }
    .btn.ghost{ background: rgba(255,255,255,.03); }
    .btn.danger{ background: rgba(255,107,107,.12); border-color: rgba(255,107,107,.40); }
    .btn:disabled{opacity:.45; cursor:not-allowed;}

    .toast{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      font-size: 12px;
      line-height:1.6;
      opacity:.92;
      white-space:pre-line;
    }
    .toast.ok{border-color: rgba(65,209,138,.35); background: rgba(65,209,138,.08);}
    .toast.bad{border-color: rgba(255,107,107,.35); background: rgba(255,107,107,.08);}
    .toast.warn{border-color: rgba(255,204,102,.35); background: rgba(255,204,102,.08);}

    label{display:block; font-size:12px; opacity:.88; margin-bottom:6px;}
    .field{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
      min-width:0;
      display:block;
    }
    input[type="date"].field{
      min-width:0;
      width:100%;
      max-width:100%;
      display:block;
    }
    .field:focus{
      border-color: color-mix(in oklab, var(--accent2) 55%, white 0%);
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent2) 18%, transparent);
    }
    .err{color:#ff6b6b; font-size:12px; margin-top:6px; line-height:1.5; display:none;}

    /* ===== Question Card ===== */
    .qCard{
      flex: 1;
      min-height:0;
      padding: 14px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(700px 280px at 10% 10%, color-mix(in oklab, var(--accent1) 18%, transparent), transparent 55%),
        radial-gradient(650px 260px at 90% 35%, color-mix(in oklab, var(--accent2) 12%, transparent), transparent 60%),
        rgba(255,255,255,.04);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      display:flex;
      flex-direction:column;
      gap: 10px;
      overflow:hidden;
    }

    .qTop{display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap:wrap;}
    .qMeta{display:flex; gap:10px; align-items:center; flex-wrap:wrap; font-size:12px; opacity:.92;}
    .chip{
      display:inline-flex; gap:8px; align-items:center;
      padding: 6px 10px; border-radius:999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      white-space:nowrap;
    }
    .chapterBadge{
      border-color: color-mix(in oklab, var(--accent1) 25%, rgba(255,255,255,.14));
      background: color-mix(in oklab, var(--accent1) 12%, rgba(255,255,255,.04));
    }

    .qText{
      margin: 0;
      font-size: 15px;
      letter-spacing:.02em;
      line-height:1.7;
      word-break: normal;
      overflow-wrap: anywhere;
    }

    #qTagChip{display:none !important;}

    .scaleWrap{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
      padding: 12px 12px;
    }

    .scaleHead{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 8px;
      align-items:center;
      font-size:12px;
      opacity:.92;
    }
    .scaleHead span:first-child{ text-align:left; }
    .scaleHead span:last-child{ text-align:right; }

    .valuePill{
      min-width: 44px; text-align:center; font-weight:700; font-size:13px;
      padding: 6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      box-shadow: 0 0 0 3px rgba(0,0,0,.10) inset;
    }

    .range{
      margin-top: 10px;
      width: 100%;
      -webkit-appearance: none;
      appearance: none;
      height: 10px;
      border-radius: 999px;
      outline:none;
      border: 1px solid rgba(255,255,255,.14);
      background:
        linear-gradient(90deg,
          var(--fillColor) 0%,
          var(--fillColor) var(--fillPct),
          rgba(255,255,255,.10) var(--fillPct),
          rgba(255,255,255,.10) 100%);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.10);
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .range::-webkit-slider-runnable-track{height:10px; border-radius:999px;}
    .range::-webkit-slider-thumb{
      -webkit-appearance:none; appearance:none;
      width:26px; height:26px; border-radius:999px;
      border: 1px solid rgba(255,255,255,.26);
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.96), rgba(255,255,255,.20) 40%, color-mix(in oklab, var(--fillColor) 72%, rgba(0,0,0,.10)) 76%),
        radial-gradient(circle at 70% 70%, rgba(255,255,255,.16), rgba(255,255,255,0) 62%);
      box-shadow:
        0 0 18px color-mix(in oklab, var(--fillColor) 40%, transparent),
        0 0 12px rgba(0,0,0,.25);
      margin-top: -8px;
      transform: scale(var(--thumbScale, 1));
      transition: transform .10s linear;
    }
    .range::-moz-range-track{
      height: 10px; border-radius:999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
    }
    .range::-moz-range-thumb{
      width:26px; height:26px; border-radius:999px;
      border: 1px solid rgba(255,255,255,.26);
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.96), rgba(255,255,255,.20) 40%, color-mix(in oklab, var(--fillColor) 72%, rgba(0,0,0,.10)) 76%);
      box-shadow: 0 0 18px color-mix(in oklab, var(--fillColor) 40%, transparent), 0 0 12px rgba(0,0,0,.25);
      transform: scale(var(--thumbScale, 1));
      transition: transform .10s linear;
    }

    .tickRow{margin-top:10px; display:grid; grid-template-columns:repeat(7, 1fr); gap:6px;}
    .tickBtn{
      appearance:none; border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: rgba(234,240,255,.88);
      border-radius: 12px;
      padding: 9px 0;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transition: transform .08s ease, border-color .2s ease, background .2s ease;
    }
    .tickBtn:active{ transform: translateY(1px) scale(.995); }
    .tickBtn.on{
      border-color: color-mix(in oklab, var(--fillColor) 55%, rgba(255,255,255,.12));
      background: color-mix(in oklab, var(--fillColor) 18%, rgba(255,255,255,.03));
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--fillColor) 14%, transparent);
      color: rgba(234,240,255,.96);
    }

    body.isQuestions .qCard .btnRow{ margin-top: 0; }
    body.isQuestions #btnResetFromQuestions{
      padding: 9px 10px;
      font-size: 12px;
      border-radius: 12px;
      max-width: 240px;
    }

    /* ===== Bottom Nav ===== */
    .bottomNav{
      position: fixed; left:0; right:0; bottom:0; z-index:90;
      padding: 10px 12px calc(10px + var(--safeBottom));
      background: linear-gradient(180deg, rgba(7,11,26,.10), rgba(7,11,26,.86));
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255,255,255,.08);
    }
    .bottomNavInner{
      max-width:1180px; margin:0 auto;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }

    /* ===== Mini Map (常時表示) ===== */
    .miniMapFloat{
      position: fixed;
      right: 12px;

      /* ★ここが位置：bottomNavの上 + safe-area + さらに上へ持ち上げ */
      bottom: calc(var(--bottomH) + var(--safeBottom) + 12px + var(--miniMapLift));

      z-index: 95;
      width: 164px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(10,14,36,.55);
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      backdrop-filter: blur(14px);
      overflow:hidden;
      padding: 10px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    .miniMapFloat:active{ transform: translateY(1px); }
    .miniMapHead{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      font-size:12px; opacity:.92;
      margin-bottom:8px;
    }
    .miniMapHint{font-size:11px; opacity:.70; margin-top:6px; text-align:center;}

    @media(max-width:420px){
      .miniMapFloat{ width: 150px; right: 10px; padding: 9px; }
      .miniMapHint{ display:none; }
    }

    /* ===== Modal ===== */
    .modalBack{
      position: fixed; inset:0; z-index:200;
      background: rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      padding: 18px;
    }
    .modal{
      width: min(760px, 96vw);
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.16);
      background:
        radial-gradient(600px 240px at 20% 20%, color-mix(in oklab, var(--accent1) 22%, transparent), transparent 60%),
        radial-gradient(600px 240px at 80% 35%, color-mix(in oklab, var(--accent2) 16%, transparent), transparent 62%),
        rgba(10,14,36,.80);
      box-shadow: 0 18px 70px rgba(0,0,0,.55);
      padding: 18px;
      backdrop-filter: blur(14px);
      position:relative;
      overflow:hidden;
      max-height: calc(100svh - 26px);
      overflow:auto;
    }
    .modalGlow{
      position:absolute; inset:-60px -80px;
      background:
        radial-gradient(120px 80px at 20% 30%, rgba(255,255,255,.14), rgba(255,255,255,0) 70%),
        radial-gradient(120px 80px at 70% 50%, rgba(255,255,255,.10), rgba(255,255,255,0) 70%);
      animation: modalFloat 3.6s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes modalFloat{
      0%,100%{ transform: translateY(0px); opacity:.9; }
      50%{ transform: translateY(10px); opacity:1; }
    }
    .modalTitle{margin:0; font-size:16px; letter-spacing:.06em;}
    .modalBody{margin-top:10px; font-size:13px; line-height:1.8; opacity:.92;}
    .rewardRow{margin-top:12px; display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .reward{
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      padding: 10px;
      font-size:12px;
      line-height:1.6;
    }

    /* ===== Ascent Map (詳細) ===== */
    .ascentWrap{
      margin-top: 12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      padding: 10px;
      overflow:hidden;
      position:relative;
    }
    .ascentCaption{
      margin-top:10px;
      font-size:12px;
      line-height:1.6;
      color: rgba(234,240,255,.88);
    }
    #ascentPathProg{transition: stroke-dashoffset .38s ease;}
    .ascentPulse{animation: ascentPulse .9s ease-out 1; transform-origin:center;}
    @keyframes ascentPulse{
      0%{ transform: scale(1); }
      40%{ transform: scale(1.16); }
      100%{ transform: scale(1); }
    }
    .floaty{animation: floaty 2.8s ease-in-out infinite;}
    @keyframes floaty{0%,100%{transform:translateY(0)}50%{transform:translateY(4px)}}

    .chapterFlash{
      position: fixed; inset:0; z-index:150;
      pointer-events:none;
      opacity:0;
      background:
        radial-gradient(800px 420px at 50% 35%, color-mix(in oklab, var(--accent3) 28%, transparent), transparent 68%),
        radial-gradient(900px 520px at 50% 80%, color-mix(in oklab, var(--accent2) 18%, transparent), transparent 70%),
        rgba(255,255,255,.02);
      transition: opacity .42s ease;
    }
    .chapterFlash.on{opacity:1;}

    [hidden]{display:none !important;}
    .footer{text-align:center; margin-top:18px; font-size:12px; opacity:.78;}

    @media (max-height: 740px){
      body.isQuestions .qCard{ padding: 12px; gap: 8px; }
      .qText{ font-size: 14px; line-height: 1.55; }
      .tickBtn{ padding: 8px 0; }
      .scaleWrap{ padding: 10px 10px; }
      body.isQuestions #btnResetFromQuestions{ padding: 8px 9px; }
    }
  </style>
</head>

<body>
  <div class="chapterFlash" id="chapterFlash" aria-hidden="true"></div>

  <header class="topbar" id="topbar">
    <div class="topbarInner">
      <div class="brand">
        <div class="orb" aria-hidden="true"></div>
        <div style="min-width:0;">
          <h1 class="title">FortuneAI式 17タイプ診断</h1>
          <div class="subtitle" id="topSubtitle">100問×7段階スライダー。神秘の巡礼路で上昇</div>
        </div>
      </div>

      <div class="meter">
        <div class="waterBar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
          <div class="waterFill" id="waterFill">
            <div class="sparkles" aria-hidden="true"></div>
          </div>
        </div>
        <div class="meterText" id="meterText">0 / 100</div>
      </div>
    </div>
  </header>

  <!-- ミニマップ常時表示（質問画面でのみ表示） -->
  <div class="miniMapFloat" id="miniMapBtn" style="display:none;" role="button" aria-label="巡礼路（詳細）">
    <div class="miniMapHead">
      <div>巡礼路</div>
      <div><strong id="miniPct">0%</strong></div>
    </div>
    <svg id="miniSvg" viewBox="0 0 320 220" width="100%" height="120" aria-hidden="true">
      <defs>
        <linearGradient id="miniStroke" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" stop-color="var(--accent1)"/>
          <stop offset="55%" stop-color="var(--accent3)"/>
          <stop offset="100%" stop-color="var(--accent2)"/>
        </linearGradient>
        <filter id="miniGlow">
          <feGaussianBlur stdDeviation="2.0" result="b"/>
          <feMerge>
            <feMergeNode in="b"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
      </defs>
      <path id="miniPathBase"
        d="M42 190
           C 72 176, 88 172, 106 160
           C 126 146, 120 128, 140 118
           C 158 109, 166 128, 184 112
           C 202 96, 180 78, 200 68
           C 224 56, 236 84, 258 58
           C 274 38, 230 32, 196 40
           C 172 46, 168 34, 160 24"
        fill="none" stroke="rgba(255,255,255,.14)" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>
      <path id="miniPathProg"
        d="M42 190
           C 72 176, 88 172, 106 160
           C 126 146, 120 128, 140 118
           C 158 109, 166 128, 184 112
           C 202 96, 180 78, 200 68
           C 224 56, 236 84, 258 58
           C 274 38, 230 32, 196 40
           C 172 46, 168 34, 160 24"
        fill="none" stroke="url(#miniStroke)" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" filter="url(#miniGlow)"/>
      <g id="miniMarker" filter="url(#miniGlow)">
        <circle id="miniHalo" cx="42" cy="190" r="10" fill="rgba(255,255,255,.10)"/>
        <circle id="miniDot" cx="42" cy="190" r="5.5" fill="rgba(255,255,255,.92)" stroke="rgba(255,255,255,.22)"/>
      </g>
    </svg>
    <div class="miniMapHint">タップで詳細</div>
  </div>

  <div class="wrap" id="wrap">
    <section class="card" id="viewHero">
      <h2 class="h1">診断を開始</h2>
      <p class="lead">
        20問ごとに章が切り替わり、配色が変化します。進捗は“水が溜まるゲージ”と“神秘の巡礼路”で上昇します。
      </p>
      <div class="pillRow">
        <div class="pill">7段階（1〜7）</div>
        <div class="pill">20問ごとに演出</div>
        <div class="pill">値で色が変わる</div>
        <div class="pill">ミニマップ常時表示</div>
      </div>
      <div class="btnRow">
        <button class="btn primary" id="btnStart">開始</button>
        <button class="btn danger" id="btnResetAll">最初からやり直す（保存を消去）</button>
      </div>
    </section>

    <section class="card" id="viewProfile" hidden>
      <h2 class="h1">プロフィール</h2>
      <p class="lead muted small">※保存復元あり。userIdはURL（?userId=...）でも渡せます。お名前はニックネームでも可能です</p>

      <div style="margin-top:12px;">
        <label for="name">お名前（必須）</label>
        <input class="field" id="name" type="text" placeholder="例：太郎" />
        <div class="err" id="errName">お名前を入力してください。</div>

        <div style="height:12px;"></div>

        <label for="gender">性別（必須）</label>
        <select class="field" id="gender">
          <option value="">選択してください</option>
          <option value="male">male（男性）</option>
          <option value="female">female（女性）</option>
          <option value="other">other（その他）</option>
        </select>
        <div class="err" id="errGender">性別を選択してください。</div>

        <div style="height:12px;"></div>

        <label for="birthday">生年月日（必須）</label>
        <input class="field" id="birthday" type="date" />
        <div class="err" id="errBirthday">生年月日を入力してください。</div>

        <div style="height:12px;"></div>

        <label for="userId">userId（任意）</label>
        <input class="field" id="userId" type="text" placeholder="例：Uxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" />

        <div class="btnRow">
          <button class="btn ghost" id="btnBackToHero">戻る</button>
          <button class="btn primary" id="btnToQuestions">回答へ進む</button>
        </div>

        <div class="toast warn" id="profileRestoreNote" style="display:none;">
          保存データを検出しました。プロフィール・回答・進捗を復元しています。
        </div>
      </div>
    </section>

    <section class="card" id="viewQuestions" hidden>
      <div class="qCard">
        <div class="qTop">
          <div class="qMeta">
            <span class="chip chapterBadge" id="chapterChip">CHAPTER 1 / 5</span>
            <span class="chip" id="qIndexChip">Q 1 / 100</span>
            <span class="chip" id="qTagChip">[S+]</span>
          </div>
          <div class="qMeta">
            <span class="chip">完了 <strong id="doneCountText">0</strong></span>
          </div>
        </div>

        <div class="qText" id="qText">Q1. （設問）</div>

        <div class="scaleWrap">
          <div class="scaleHead">
            <span>1 = まったくそう思わない</span>
            <span class="valuePill" id="valuePill">4</span>
            <span>7 = 非常にそう思う</span>
          </div>

          <input id="range" class="range" type="range" min="1" max="7" step="1" value="4" />
          <div class="tickRow" id="tickRow"></div>
        </div>

        <div class="toast" id="qToast" style="display:none;"></div>

        <div class="sep"></div>

        <div class="btnRow">
          <button class="btn ghost" id="btnJumpProfile">プロフィールへ戻る</button>
          <button class="btn danger" id="btnResetFromQuestions">最初からやり直す（保存を消去）</button>
        </div>
      </div>
    </section>

    <section class="card" id="viewWorry" hidden>
      <h2 class="h1">悩み入力</h2>
      <p class="lead">最終送信payloadの <code>worryText</code> に入ります（最大2000文字）。</p>
      <label for="worryText" style="margin-top:12px;">悩み</label>
      <textarea class="field" id="worryText" maxlength="2000" style="min-height:160px; resize:vertical; line-height:1.6;"></textarea>

      <div class="btnRow" style="justify-content:space-between;">
        <div class="muted small" id="worryCount">0 / 2000</div>
        <button class="btn primary" id="btnShowResult">結果を見る</button>
      </div>
    </section>

    <section class="card" id="viewResult" hidden>
      <h2 class="h1">結果</h2>
      <div class="sep"></div>

      <div class="toast" id="resultToast" style="display:none;"></div>

      <div class="btnRow">
        <button class="btn primary" id="btnFinalSubmit">最終送信（final_submit）</button>
        <button class="btn ghost" id="btnCopyJson">JSONをコピー</button>
        <button class="btn ghost" id="btnDownloadJson">JSONをダウンロード</button>
        <button class="btn danger" id="btnResetFromResult">最初からやり直す（保存を消去）</button>
      </div>

      <div id="jsonPreviewWrap" style="display:none;">
        <div class="sep"></div>
        <p class="lead"><b>JSONプレビュー（WEBHOOK_URL未設定時）</b></p>
        <pre class="field" id="jsonPreview" style="max-height:320px; overflow:auto; white-space:pre; font-size:11.5px; line-height:1.55;"></pre>
      </div>
    </section>

    <div class="footer">© FortuneAI</div>
  </div>

  <div class="bottomNav" id="bottomNav" style="display:none;">
    <div class="bottomNavInner">
      <button class="btn ghost" id="btnPrevQ">前へ</button>
      <button class="btn primary" id="btnNextQ">次へ</button>
    </div>
  </div>

  <!-- 章クリアモーダル -->
  <div class="modalBack" id="chapterModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalGlow" aria-hidden="true"></div>
      <h3 class="modalTitle" id="chapterModalTitle">CHAPTER CLEAR</h3>
      <div class="modalBody" id="chapterModalBody"></div>

      <div class="rewardRow">
        <div class="reward" id="reward1"></div>
        <div class="reward" id="reward2"></div>
      </div>

      <div class="btnRow" style="justify-content:flex-end;">
        <button class="btn primary" id="btnChapterContinue">次の章へ</button>
      </div>
    </div>
  </div>

  <!-- 巡礼路（詳細）モーダル -->
  <div class="modalBack" id="mapModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalGlow" aria-hidden="true"></div>
      <h3 class="modalTitle">神秘の巡礼路（詳細）</h3>
      <div class="modalBody" id="ascentModalBody">回答が進むほど、光の道が伸び、精霊が上昇します。20問ごとに建造物が点灯します。</div>

      <div class="ascentWrap">
        <svg id="ascentSvg" viewBox="0 0 320 220" width="100%" height="260" aria-label="巡礼路">
          <defs>
            <radialGradient id="ascentGlow" cx="50%" cy="40%" r="70%">
              <stop offset="0%" stop-color="rgba(255,255,255,.12)"/>
              <stop offset="60%" stop-color="rgba(255,255,255,.03)"/>
              <stop offset="100%" stop-color="rgba(255,255,255,0)"/>
            </radialGradient>

            <linearGradient id="ascentStroke" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="var(--accent1)"/>
              <stop offset="55%" stop-color="var(--accent3)"/>
              <stop offset="100%" stop-color="var(--accent2)"/>
            </linearGradient>

            <filter id="softGlow">
              <feGaussianBlur stdDeviation="2.2" result="b"/>
              <feMerge>
                <feMergeNode in="b"/>
                <feMergeNode in="SourceGraphic"/>
              </feMerge>
            </filter>
          </defs>

          <rect x="0" y="0" width="320" height="220" fill="url(#ascentGlow)"/>

          <g opacity=".95">
            <path d="M160 18 L176 58 L160 48 L144 58 Z" fill="rgba(255,255,255,.10)" stroke="rgba(255,255,255,.16)"/>
            <circle cx="160" cy="18" r="6" fill="rgba(255,255,255,.22)" stroke="rgba(255,255,255,.22)"/>
            <text x="160" y="14" text-anchor="middle" font-size="10" fill="rgba(234,240,255,.85)" style="letter-spacing:.12em;">GOAL</text>
          </g>

          <path id="ascentPathBase"
            d="M42 190
               C 72 176, 88 172, 106 160
               C 126 146, 120 128, 140 118
               C 158 109, 166 128, 184 112
               C 202 96, 180 78, 200 68
               C 224 56, 236 84, 258 58
               C 274 38, 230 32, 196 40
               C 172 46, 168 34, 160 24"
            fill="none"
            stroke="rgba(255,255,255,.14)"
            stroke-width="6"
            stroke-linecap="round"
            stroke-linejoin="round"/>

          <path id="ascentPathProg"
            d="M42 190
               C 72 176, 88 172, 106 160
               C 126 146, 120 128, 140 118
               C 158 109, 166 128, 184 112
               C 202 96, 180 78, 200 68
               C 224 56, 236 84, 258 58
               C 274 38, 230 32, 196 40
               C 172 46, 168 34, 160 24"
            fill="none"
            stroke="url(#ascentStroke)"
            stroke-width="6"
            stroke-linecap="round"
            stroke-linejoin="round"
            filter="url(#softGlow)"/>

          <g id="ascentRunes" opacity=".95"></g>
          <g id="ascentBuildings" opacity=".98"></g>

          <g id="ascentMarker" filter="url(#softGlow)">
            <circle id="ascentHalo" cx="42" cy="190" r="10" fill="rgba(255,255,255,.10)"/>
            <circle id="ascentDot" cx="42" cy="190" r="5.5" fill="rgba(255,255,255,.92)" stroke="rgba(255,255,255,.22)"/>
            <path id="ascentWisp" class="floaty" d="M42 178 C 46 172, 54 176, 50 184 C 48 188, 44 190, 42 194 C 40 190, 36 188, 34 184 C 30 176, 38 172, 42 178 Z"
              fill="rgba(255,255,255,.18)" stroke="rgba(255,255,255,.22)"/>
          </g>

          <g id="ascentParticles" opacity=".9"></g>

          <text x="42" y="206" text-anchor="start" font-size="10" fill="rgba(234,240,255,.70)" style="letter-spacing:.12em;">START</text>
        </svg>

        <div class="ascentCaption" id="ascentCaption">まずは1問。光が道を描き始めます。</div>
      </div>

      <div class="btnRow" style="justify-content:flex-end;">
        <button class="btn primary" id="btnCloseMap">閉じる</button>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * ここだけ編集（MakeのWebhook）
     ***********************/
    const WEBHOOK_URL = "https://hook.eu2.make.com/7ac62r32ffup0cl0d1kr9h3dpbf8dz3h";
    const STORAGE_KEY = "fortuneai_17type_mystic_ascent_singlefile";

    const AXIS_MAX = 75;

    const THEMES = [
      { name:"CHAPTER 1 / 5", a1:"#7c4dff", a2:"#cfa76e", a3:"#43d3ff", bg0:"#070b1a", bg1:"#0b1231" },
      { name:"CHAPTER 2 / 5", a1:"#43d3ff", a2:"#7c4dff", a3:"#cfa76e", bg0:"#06101a", bg1:"#071a2b" },
      { name:"CHAPTER 3 / 5", a1:"#cfa76e", a2:"#43d3ff", a3:"#7c4dff", bg0:"#120c0a", bg1:"#0b1231" },
      { name:"CHAPTER 4 / 5", a1:"#ff6bd6", a2:"#43d3ff", a3:"#cfa76e", bg0:"#0d0616", bg1:"#08163a" },
      { name:"CHAPTER 5 / 5", a1:"#41d18a", a2:"#cfa76e", a3:"#7c4dff", bg0:"#060f0d", bg1:"#081a2b" },
    ];

    const TYPE_TITLES = {
      "INTJ":"FortuneAI：黒曜アーキテクト（戦略設計者）",
      "INTP":"FortuneAI：蒼天アナリスト（原理解剖者）",
      "ENTJ":"FortuneAI：紅蓮コマンダー（成果指揮者）",
      "ENTP":"FortuneAI：雷光インベンター（変革発明者）",
      "INFJ":"FortuneAI：星導シーア（未来洞察者）",
      "INFP":"FortuneAI：月影バード（理想詩人）",
      "ENFJ":"FortuneAI：旭日メンター（覚醒導師）",
      "ENFP":"FortuneAI：虹彩オラクル（可能性点火者）",
      "ISTJ":"FortuneAI：鉄律マーシャル（秩序監督者）",
      "ISFJ":"FortuneAI：守灯スチュワード（献身支援者）",
      "ESTJ":"FortuneAI：白鋼マーシャル（現場統制者）",
      "ESFJ":"祝祭ホスト（調和演出者）",
      "ISTP":"影刃スミス（実務解体者）",
      "ISFP":"花晶アーティザン（美感匠）",
      "ESTP":"疾風ストライカー（機会攻略者）",
      "ESFP":"陽光パフォーマー（感情起動者）",
      "BAL":"均衡アルケミスト（統合適応者）"
    };

    const TAROT_MAJOR = {
      "INTJ":"隠者","INTP":"正義","ENTJ":"皇帝","ENTP":"魔術師","INFJ":"女教皇","INFP":"星","ENFJ":"太陽","ENFP":"愚者",
      "ISTJ":"教皇","ISFJ":"節制","ESTJ":"戦車","ESFJ":"女帝","ISTP":"力","ISFP":"恋人","ESTP":"運命の輪","ESFP":"世界","BAL":"審判"
    };

    /***********************
     * 設問100（固定）
     ***********************/
    const QUESTIONS = buildDefaultQuestions();
    function buildDefaultQuestions(){
      const out = [];
      const mk = (id, text, tag) => ({ id, text, tag });
      const E = [
        ["初対面の場でも、自然に話しかけるほうだ","[E+]"],
        ["一人で過ごす時間が長いほど安心する","[E-]"],
        ["人が集まる場に行くとエネルギーが湧く","[E+]"],
        ["雑談よりも、必要な会話だけで十分だ","[E-]"],
        ["相談されると、すぐ反応して場を動かしたくなる","[E+]"],
        ["予定が詰まると, まず距離を取りたくなる","[E-]"],
        ["新しいコミュニティに入るのが楽しみだ","[E+]"],
        ["考えをまとめてからでないと発言しにくい","[E-]"],
        ["人前で話すことに抵抗が少ない","[E+]"],
        ["大勢の中にいるより、少人数が落ち着く","[E-]"],
        ["即興で会話を広げるのが得意だ","[E+]"],
        ["会話の後は、一人で回復する時間が必要だ","[E-]"],
        ["周囲のテンションに合わせて盛り上げられる","[E+]"],
        ["発言前に、頭の中で何度もシミュレーションする","[E-]"],
        ["場の空気を読んで率先して動く","[E+]"],
        ["自分の世界に入る時間がないと消耗する","[E-]"],
        ["他人と一緒に作業する方が捗る","[E+]"],
        ["連絡は最低限でいいと感じる","[E-]"],
        ["新しい人脈作りに前向きだ","[E+]"],
        ["静かな環境の方が集中できる","[E-]"],
        ["反応が返ってくるやり取りが好きだ","[E+]"],
        ["自分の内側で結論が出るまで話したくない","[E-]"],
        ["イベントや集まりを企画するのが好きだ","[E+]"],
        ["社交の後は疲れがどっと出る","[E-]"],
        ["人と話すほどアイデアが出る","[E+]"],
      ];
      const S = [
        ["事実や実例をもとに判断することが多い","[S+]"],
        ["抽象的な可能性を考えるのが好きだ","[S-]"],
        ["今ある情報を丁寧に確認して進めたい","[S+]"],
        ["『もし〜なら』の仮説を立てるのが楽しい","[S-]"],
        ["手順や具体策を固めると安心する","[S+]"],
        ["細部より全体像や意味を先に掴みたい","[S-]"],
        ["現実的な制約を踏まえて決める","[S+]"],
        ["直感的なひらめきで方向性を決めることがある","[S-]"],
        ["経験に基づく再現性を重視する","[S+]"],
        ["未来のトレンドや流れを想像しやすい","[S-]"],
        ["数字や根拠があると納得しやすい","[S+]"],
        ["曖昧でもビジョンがあれば動ける","[S-]"],
        ["具体的な改善点を列挙できる","[S+]"],
        ["象徴や比喩で理解する方がしっくりくる","[S-]"],
        ["現場感覚や実務の感触を大切にする","[S+]"],
        ["今は無い可能性にワクワクする","[S-]"],
        ["計画は現実に落とし込めるかを確認する","[S+]"],
        ["常識を疑って新しい解釈を探す","[S-]"],
        ["目の前の課題を一つずつ解くのが得意","[S+]"],
        ["パターンや共通点を見つけるのが得意","[S-]"],
        ["具体例があると理解が早い","[S+]"],
        ["コンセプトや世界観から発想する","[S-]"],
        ["小さな変化に気づきやすい","[S+]"],
        ["本質を掴めば細部は後からでいい","[S-]"],
        ["現実のリスクを先に洗い出す","[S+]"],
      ];
      const T = [
        ["結論は論理の整合性を優先したい","[T+]"],
        ["相手の気持ちを優先して言い方を選ぶ","[T-]"],
        ["公平なルールに沿って判断したい","[T+]"],
        ["衝突を避けるために配慮することが多い","[T-]"],
        ["感情よりも事実を先に整理する","[T+]"],
        ["場の雰囲気や人間関係を重視する","[T-]"],
        ["効率や成果を基準に意思決定する","[T+]"],
        ["相手が傷つかないことが最重要だ","[T-]"],
        ["議論で弱点を指摘されても冷静でいられる","[T+]"],
        ["共感されると安心する","[T-]"],
        ["原因と結果を分解して考える","[T+]"],
        ["誰かの努力や背景を汲み取りたい","[T-]"],
        ["正しい/間違いをはっきりさせたい","[T+]"],
        ["『正しさ』より『やさしさ』を優先する","[T-]"],
        ["合理性が低い提案は見直したくなる","[T+]"],
        ["相手の立場に立つと決めきれないことがある","[T-]"],
        ["数字で説明できると安心する","[T+]"],
        ["感情の納得感がないと進めにくい","[T-]"],
        ["評価基準を明確にしてから動く","[T+]"],
        ["和を乱さないように調整するのが得意","[T-]"],
        ["長期的に得かどうかで選ぶ","[T+]"],
        ["関係性が壊れそうなら方針を変える","[T-]"],
        ["最適解を探すのが好きだ","[T+]"],
        ["相手が安心できる説明を心がける","[T-]"],
        ["結論を急がず気持ちを整える時間も必要","[T-]"],
      ];
      const J = [
        ["締切や計画がある方が動きやすい","[J+]"],
        ["選択肢を残しておきたい","[J-]"],
        ["ToDoを整理して順番に処理する","[J+]"],
        ["その場の流れで柔軟に決めたい","[J-]"],
        ["予定は早めに確定したい","[J+]"],
        ["直前まで迷って最良を選びたい","[J-]"],
        ["ルールや手順に沿って進めたい","[J+]"],
        ["型にハマらず試行錯誤したい","[J-]"],
        ["部屋やデータは整っている方が落ち着く","[J+]"],
        ["散らかっていても必要ならすぐ動ける","[J-]"],
        ["決めたら最後までやり切りたい","[J+]"],
        ["状況次第で方針を変えるのが自然だ","[J-]"],
        ["まずゴールと期限を決める","[J+]"],
        ["やりながら目的が変わることもある","[J-]"],
        ["手帳やメモで管理する習慣がある","[J+]"],
        ["計画よりも勢いが大事だと思う","[J-]"],
        ["『完了』の状態を作るのが好きだ","[J+]"],
        ["未完成でも進めながら整えたい","[J-]"],
        ["予想外が起きてもリカバリ計画を立てる","[J+]"],
        ["選択肢が多いほどワクワクする","[J-]"],
        ["チェックリストがあると安心する","[J+]"],
        ["締切がないと面白い方へ寄り道する","[J-]"],
        ["先に段取りを決めてから動く","[J+]"],
        ["その時の気分で優先順位が変わる","[J-]"],
        ["結論を早めに固めてスッキリしたい","[J+]"],
      ];
      let id = 1;
      for (const [t, tag] of E) out.push(mk(id++, `Q${id-1}. ${t}`, tag));
      for (const [t, tag] of S) out.push(mk(id++, `Q${id-1}. ${t}`, tag));
      for (const [t, tag] of T) out.push(mk(id++, `Q${id-1}. ${t}`, tag));
      for (const [t, tag] of J) out.push(mk(id++, `Q${id-1}. ${t}`, tag));
      if (out.length !== 100) throw new Error("QUESTIONS must be 100");
      return out;
    }

    /* 以降のJSは、あなたのコードと同一なので省略せずに続けて貼ってOKです。
       ここから下は、あなたが送ってくれたJSをそのまま貼れば動きます。 */
  </script>
</body>
</html>
