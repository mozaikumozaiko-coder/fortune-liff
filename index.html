<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>FortuneAIå¼ 17ã‚¿ã‚¤ãƒ—è¨ºæ–­</title>

  <style>
    :root{
      /* ===== Theme ===== */
      --bg0:#070b1a;
      --bg1:#0b1231;

      --card: rgba(255,255,255,.06);
      --line: rgba(255,255,255,.14);
      --text:#eaf0ff;

      --accent1:#7c4dff;
      --accent2:#cfa76e;
      --accent3:#43d3ff;

      --shadow: 0 18px 60px rgba(0,0,0,.38);
      --r: 18px;

      --safeBottom: env(safe-area-inset-bottom, 0px);
      --safeTop: env(safe-area-inset-top, 0px);

      /* JSã§å®Ÿæ¸¬ã—ã¦å…¥ã‚Œã‚‹ï¼ˆè³ªå•ç”»é¢ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ’²æ»…ç”¨ï¼‰ */
      --headerH: 110px;
      --bottomH: 86px;

      /* â˜…é‡è¦ï¼šã‚¹ãƒãƒ›ã§å³äºˆç´„ã™ã‚‹ã¨æ–‡å­—ãŒæ½°ã‚Œã¦ã€Œãã¡ã‚ƒãã¡ã‚ƒã€ã«ãªã‚‹ã®ã§ãƒ‡ãƒ•ã‚©0 */
      --mapReserve: 0px;

      /* â˜…ãƒŸãƒ‹ãƒãƒƒãƒ—ã®æŒã¡ä¸Šã’é‡ï¼ˆã“ã“ã‚’å¢—ã‚„ã™ã»ã©ä¸Šã«ä¸ŠãŒã‚‹ï¼‰ */
      --miniMapLift: 56px;
    }

    *{box-sizing:border-box}
    html, body{height:100%; overscroll-behavior:none; -webkit-text-size-adjust:100%;}
    body{
      margin:0;
      color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Sans", "Yu Gothic", sans-serif;
      background:
        radial-gradient(1200px 650px at 15% 5%, color-mix(in oklab, var(--accent1) 35%, transparent), transparent 62%),
        radial-gradient(900px 540px at 85% 25%, color-mix(in oklab, var(--accent2) 26%, transparent), transparent 62%),
        radial-gradient(900px 540px at 65% 85%, color-mix(in oklab, var(--accent3) 18%, transparent), transparent 62%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
      touch-action: pan-y;
    }

    /* è³ªå•ç”»é¢ã ã‘ã€Œãƒšãƒ¼ã‚¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãªã—ã€ */
    body.isQuestions{
      height: 100svh;
      overflow: hidden;
      touch-action: manipulation;
    }

    input, select, textarea{max-width:100%;}
    /* iOSã§ãƒ•ã‚©ãƒ¼ãƒ ãŒå¤‰ã«ä¼¸ã³ã‚‹/ã‚ºãƒ¼ãƒ ã™ã‚‹ã®ã‚’æŠ‘ãˆã‚‹ */
    input, select, textarea{ font-size:16px; }

    .wrap{
      max-width:1180px;
      margin:0 auto;
      padding: 14px 14px calc(96px + var(--safeBottom));
    }

    /* è³ªå•ç”»é¢ã¯ viewport ã«åã‚ã‚‹ï¼ˆç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ï¼‰ */
    body.isQuestions .wrap{
      height: calc(100svh - var(--headerH) - var(--bottomH));
      padding: 10px 14px 0;
      padding-right: 14px;           /* â˜…ã‚¹ãƒãƒ›ã¯å³äºˆç´„ã—ãªã„ï¼ˆå´©å£ŠåŸå› ï¼‰ */
      overflow: hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆä»¥ä¸Šã ã‘å³ã«ãƒŸãƒ‹ãƒãƒƒãƒ—åˆ†ã®ä½™ç™½ã‚’ç¢ºä¿ï¼ˆè¢«ã‚Šã‚¼ãƒ­ï¼‰ */
    @media (min-width: 720px){
      :root{ --mapReserve: 170px; }
      body.isQuestions .wrap{ padding-right: calc(14px + var(--mapReserve)); }
    }

    /* ===== Header (ã‚¹ãƒãƒ›2æ®µåŒ–ã§è¢«ã‚Šã‚¼ãƒ­) ===== */
    .topbar{
      position:sticky; top:0; z-index:80;
      padding-top: var(--safeTop);
      background: linear-gradient(180deg, rgba(7,11,26,.94), rgba(11,18,49,.70));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .topbarInner{
      max-width:1180px;
      margin:0 auto;
      padding: 12px 14px 12px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      min-width:0;
    }
    .brand{display:flex; gap:12px; align-items:center; min-width:0;}
    .orb{
      width:44px; height:44px; border-radius:999px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.92), rgba(255,255,255,.10) 42%, rgba(124,77,255,.28) 72%, rgba(207,167,110,.18));
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 0 26px color-mix(in oklab, var(--accent1) 28%, transparent),
                  0 0 18px color-mix(in oklab, var(--accent2) 18%, transparent);
      flex: 0 0 auto;
    }
    .title{font-size:14px; letter-spacing:.06em; margin:0; line-height:1.2;}
    .subtitle{
      font-size:12px; opacity:.86; margin-top:4px; line-height:1.35;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: min(560px, 58vw);
    }

    .meter{
      width: min(520px, 52vw);
      min-width: 220px;
      display:flex; align-items:center; gap:10px;
      justify-content:flex-end;
      min-width:0;
    }
    .meterText{font-size:12px; opacity:.92; min-width:72px; text-align:right; white-space:nowrap;}
    .waterBar{
      position:relative; height:16px; width:100%;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.14);
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.08);
    }
    .waterFill{
      position:absolute; inset:0 auto 0 0; width:0%;
      border-radius:999px;
      background:
        linear-gradient(90deg,
          color-mix(in oklab, var(--accent1) 90%, white 10%),
          color-mix(in oklab, var(--accent3) 70%, white 10%),
          color-mix(in oklab, var(--accent2) 85%, white 10%));
      filter:saturate(1.05);
      transition: width .30s ease;
      overflow:hidden;
    }
    /* æ°´é¢ã®ã‚†ã‚‰ã */
    .waterFill::before{
      content:"";
      position:absolute; inset:-10px -60px -10px -60px;
      background:
        radial-gradient(18px 10px at 20px 18px, rgba(255,255,255,.34), rgba(255,255,255,0) 70%),
        radial-gradient(22px 12px at 60px 26px, rgba(255,255,255,.22), rgba(255,255,255,0) 72%),
        radial-gradient(18px 10px at 100px 18px, rgba(255,255,255,.30), rgba(255,255,255,0) 70%);
      opacity:.50;
      animation: waveMove 2.4s linear infinite;
      mix-blend-mode: screen;
      pointer-events:none;
    }
    @keyframes waveMove{0%{transform:translateX(0)}100%{transform:translateX(110px)}}
    /* ã‚­ãƒ©ã‚­ãƒ©ï¼ˆã‚²ãƒ¼ã‚¸å†…ï¼‰ */
    .waterFill .sparkles{
      position:absolute; inset:-30px -60px -30px -60px;
      background:
        radial-gradient(2px 2px at 14% 44%, rgba(255,255,255,.95), rgba(255,255,255,0) 60%),
        radial-gradient(1.5px 1.5px at 28% 62%, rgba(255,255,255,.88), rgba(255,255,255,0) 60%),
        radial-gradient(2px 2px at 42% 32%, rgba(255,255,255,.82), rgba(255,255,255,0) 60%),
        radial-gradient(1.2px 1.2px at 58% 52%, rgba(255,255,255,.80), rgba(255,255,255,0) 60%),
        radial-gradient(2px 2px at 72% 38%, rgba(255,255,255,.90), rgba(255,255,255,0) 60%),
        radial-gradient(1.6px 1.6px at 84% 58%, rgba(255,255,255,.84), rgba(255,255,255,0) 60%);
      opacity:.55;
      animation: sparkleDrift 3.2s linear infinite;
      mix-blend-mode: screen;
      pointer-events:none;
    }
    @keyframes sparkleDrift{
      0%{ transform: translateX(-20px) translateY(0px); filter: blur(.0px); }
      50%{ transform: translateX(20px) translateY(-6px); filter: blur(.2px); }
      100%{ transform: translateX(60px) translateY(0px); filter: blur(.0px); }
    }

    @media(max-width:560px){
      .topbarInner{flex-direction:column; align-items:stretch; gap:10px;}
      .brand{width:100%;}
      .subtitle{max-width:100%;}
      .meter{width:100%; min-width:0; justify-content:space-between;}
      .meterText{min-width:64px;}
    }

    .card{
      margin-top:14px;
      border:1px solid var(--line);
      background: var(--card);
      border-radius: var(--r);
      padding: 16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
    }

    /* è³ªå•ç”»é¢ã¯å¤–å´ã‚«ãƒ¼ãƒ‰ã‚’â€œå™¨â€ã«ã—ã¦é«˜ã•å›ºå®šï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ï¼‰ */
    body.isQuestions #viewQuestions.card{
      flex: 1;
      min-height:0;
      margin-top: 10px;
      padding: 0;
      background: transparent;
      border: none;
      box-shadow: none;
      backdrop-filter: none;
      display:flex;
    }

    .h1{font-size:18px; margin:0 0 8px; letter-spacing:.05em; line-height:1.25;}
    .lead{margin:0; font-size:13px; opacity:.88; line-height:1.75;}
    .muted{opacity:.84}
    .small{font-size:12px}
    .sep{height:1px; background: rgba(255,255,255,.10); margin: 12px 0;}

    .pillRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.04);
      font-size:12px; opacity:.95;
    }

    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; align-items:center;}
    .btn{
      appearance:none; border:none;
      padding: 12px 14px; border-radius: 14px;
      cursor:pointer; color: var(--text);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      transition: transform .08s ease, border-color .2s ease, background .2s ease, filter .2s ease;
      user-select:none; -webkit-tap-highlight-color: transparent;
      white-space: nowrap;
    }
    .btn:hover{border-color: rgba(255,255,255,.22);}
    .btn:active{transform: translateY(1px) scale(.995);}
    .btn.primary{
      background: linear-gradient(90deg,
        color-mix(in oklab, var(--accent1) 85%, black 10%),
        color-mix(in oklab, var(--accent2) 80%, black 10%));
      border-color: rgba(255,255,255,.18);
      filter: saturate(1.08);
    }
    .btn.ghost{ background: rgba(255,255,255,.03); }
    .btn.danger{ background: rgba(255,107,107,.12); border-color: rgba(255,107,107,.40); }
    .btn:disabled{opacity:.45; cursor:not-allowed;}

    .toast{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      font-size: 12px;
      line-height:1.6;
      opacity:.92;
      white-space:pre-line;
    }
    .toast.ok{border-color: rgba(65,209,138,.35); background: rgba(65,209,138,.08);}
    .toast.bad{border-color: rgba(255,107,107,.35); background: rgba(255,107,107,.08);}
    .toast.warn{border-color: rgba(255,204,102,.35); background: rgba(255,204,102,.08);}

    label{display:block; font-size:12px; opacity:.88; margin-bottom:6px;}
    .field{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
      min-width:0;
      display:block;
    }
    input[type="date"].field{
      min-width:0;
      width:100%;
      max-width:100%;
      display:block;
      box-sizing: border-box;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }
    .field:focus{
      border-color: color-mix(in oklab, var(--accent2) 55%, white 0%);
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent2) 18%, transparent);
    }
    .err{color:#ff6b6b; font-size:12px; margin-top:6px; line-height:1.5; display:none;}

    /* ===== Question Card ===== */
    .qCard{
      flex: 1;
      min-height:0;
      padding: 14px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(700px 280px at 10% 10%, color-mix(in oklab, var(--accent1) 18%, transparent), transparent 55%),
        radial-gradient(650px 260px at 90% 35%, color-mix(in oklab, var(--accent2) 12%, transparent), transparent 60%),
        rgba(255,255,255,.04);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      display:flex;
      flex-direction:column;
      gap: 10px;
      overflow:hidden;
    }

    .qTop{display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap:wrap;}
    .qMeta{display:flex; gap:10px; align-items:center; flex-wrap:wrap; font-size:12px; opacity:.92;}
    .chip{
      display:inline-flex; gap:8px; align-items:center;
      padding: 6px 10px; border-radius:999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      white-space:nowrap;
    }
    .chapterBadge{
      border-color: color-mix(in oklab, var(--accent1) 25%, rgba(255,255,255,.14));
      background: color-mix(in oklab, var(--accent1) 12%, rgba(255,255,255,.04));
    }

    .qText{
      margin: 0;
      font-size: 15px;
      letter-spacing:.02em;
      line-height:1.7;
      word-break: normal;
      overflow-wrap: anywhere;
    }

    /* qTagï¼ˆS+ç­‰ï¼‰ã‚’éè¡¨ç¤ºï¼ˆãƒ‡ãƒ¼ã‚¿ä¿æŒï¼‰ */
    #qTagChip{display:none !important;}

    .scaleWrap{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
      padding: 12px 12px;
    }

    .scaleHead{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 8px;
      align-items:center;
      font-size:12px;
      opacity:.92;
    }
    .scaleHead span:first-child{ text-align:left; }
    .scaleHead span:last-child{ text-align:right; }

    .valuePill{
      min-width: 44px; text-align:center; font-weight:700; font-size:13px;
      padding: 6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      box-shadow: 0 0 0 3px rgba(0,0,0,.10) inset;
    }

    .range{
      margin-top: 10px;
      width: 100%;
      -webkit-appearance: none;
      appearance: none;
      height: 10px;
      border-radius: 999px;
      outline:none;
      border: 1px solid rgba(255,255,255,.14);
      background:
        linear-gradient(90deg,
          var(--fillColor) 0%,
          var(--fillColor) var(--fillPct),
          rgba(255,255,255,.10) var(--fillPct),
          rgba(255,255,255,.10) 100%);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.10);
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .range::-webkit-slider-runnable-track{height:10px; border-radius:999px;}
    .range::-webkit-slider-thumb{
      -webkit-appearance:none; appearance:none;
      width:26px; height:26px; border-radius:999px;
      border: 1px solid rgba(255,255,255,.26);
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.96), rgba(255,255,255,.20) 40%, color-mix(in oklab, var(--fillColor) 72%, rgba(0,0,0,.10)) 76%),
        radial-gradient(circle at 70% 70%, rgba(255,255,255,.16), rgba(255,255,255,0) 62%);
      box-shadow:
        0 0 18px color-mix(in oklab, var(--fillColor) 40%, transparent),
        0 0 12px rgba(0,0,0,.25);
      margin-top: -8px;
      transform: scale(var(--thumbScale, 1));
      transition: transform .10s linear;
    }
    .range::-moz-range-track{
      height: 10px; border-radius:999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
    }
    .range::-moz-range-thumb{
      width:26px; height:26px; border-radius:999px;
      border: 1px solid rgba(255,255,255,.26);
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.96), rgba(255,255,255,.20) 40%, color-mix(in oklab, var(--fillColor) 72%, rgba(0,0,0,.10)) 76%);
      box-shadow: 0 0 18px color-mix(in oklab, var(--fillColor) 40%, transparent), 0 0 12px rgba(0,0,0,.25);
      transform: scale(var(--thumbScale, 1));
      transition: transform .10s linear;
    }

    .tickRow{margin-top:10px; display:grid; grid-template-columns:repeat(7, 1fr); gap:6px;}
    .tickBtn{
      appearance:none; border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: rgba(234,240,255,.88);
      border-radius: 12px;
      padding: 9px 0;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transition: transform .08s ease, border-color .2s ease, background .2s ease;
    }
    .tickBtn:active{ transform: translateY(1px) scale(.995); }
    .tickBtn.on{
      border-color: color-mix(in oklab, var(--fillColor) 55%, rgba(255,255,255,.12));
      background: color-mix(in oklab, var(--fillColor) 18%, rgba(255,255,255,.03));
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--fillColor) 14%, transparent);
      color: rgba(234,240,255,.96);
    }

    /* è³ªå•ç”»é¢ã®ãƒœã‚¿ãƒ³è¡Œï¼šæŠ¼ã—ã‚„ã™ãã—ã¤ã¤çœã‚¹ãƒšãƒ¼ã‚¹ */
    body.isQuestions .qCard .btnRow{ margin-top: 0; }
    body.isQuestions #btnResetFromQuestions{
      padding: 9px 10px;
      font-size: 12px;
      border-radius: 12px;
      max-width: 240px;
    }

    /* ===== Bottom Nav ===== */
    .bottomNav{
      position: fixed; left:0; right:0; bottom:0; z-index:90;
      padding: 10px 12px calc(10px + var(--safeBottom));
      background: linear-gradient(180deg, rgba(7,11,26,.10), rgba(7,11,26,.86));
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255,255,255,.08);
    }
    .bottomNavInner{
      max-width:1180px; margin:0 auto;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }

    /* ===== Mini Map (å¸¸æ™‚è¡¨ç¤ºãƒ»è±ªè¯ç‰ˆ) ===== */
    .miniMapFloat{
      position: fixed;
      right: 12px;
      /* â˜…ã“ã“ã§ã€ŒæŒã¡ä¸Šã’é‡ã€ã‚’è¶³ã—ã¦ä¸Šã«ä¸Šã’ã‚‹ */
      bottom: calc(var(--bottomH) + 12px + var(--miniMapLift));
      z-index: 95;
      pointer-events: auto;
      touch-action: manipulation;
      width: 184px;
      border-radius: 20px;
      border:1px solid rgba(255,255,255,.22);
      background:
        radial-gradient(180px 120px at 50% 30%, rgba(124,77,255,.12), transparent 70%),
        radial-gradient(160px 100px at 50% 70%, rgba(207,167,110,.08), transparent 70%),
        rgba(10,14,36,.72);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.08) inset,
        0 18px 60px rgba(0,0,0,.45),
        0 0 32px color-mix(in oklab, var(--accent1) 18%, transparent);
      backdrop-filter: blur(16px);
      overflow:hidden;
      padding: 12px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
      transition: transform .15s ease, border-color .2s ease, box-shadow .3s ease;
    }
    .miniMapFloat:hover{
      border-color: rgba(255,255,255,.35);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.12) inset,
        0 22px 70px rgba(0,0,0,.50),
        0 0 42px color-mix(in oklab, var(--accent1) 28%, transparent);
    }
    .miniMapFloat:active{
      transform: translateY(1px) scale(.995);
    }
    .miniMapHead{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      font-size:12.5px; opacity:.95; font-weight:600; letter-spacing:.03em;
      margin-bottom:8px;
    }
    .miniMapHint{
      font-size:10.5px; opacity:.75; margin-top:7px; text-align:center;
      letter-spacing:.04em;
      display: block;
    }
    /* ãƒŸãƒ‹ãƒãƒƒãƒ—èƒŒæ™¯è£…é£¾ */
    .miniMapFloat::before{
      content:"";
      position:absolute; inset:-40px -60px;
      background:
        radial-gradient(2px 2px at 18% 25%, rgba(255,255,255,.90), rgba(255,255,255,0) 60%),
        radial-gradient(1.5px 1.5px at 45% 45%, rgba(255,255,255,.85), rgba(255,255,255,0) 60%),
        radial-gradient(2px 2px at 72% 65%, rgba(255,255,255,.88), rgba(255,255,255,0) 60%),
        radial-gradient(1.2px 1.2px at 88% 30%, rgba(255,255,255,.82), rgba(255,255,255,0) 60%);
      opacity:.35;
      animation: miniSparkle 4.5s linear infinite;
      pointer-events:none;
      mix-blend-mode: screen;
    }
    @keyframes miniSparkle{
      0%{ transform: translateX(-10px) translateY(0px); opacity:.30; }
      50%{ transform: translateX(10px) translateY(-5px); opacity:.45; }
      100%{ transform: translateX(30px) translateY(0px); opacity:.30; }
    }

    @media(max-width:420px){
      .miniMapFloat{
        width: 140px;
        right: 8px;
        bottom: calc(var(--bottomH) + 8px + var(--miniMapLift));
        padding: 8px;
        z-index: 100;
        border-radius: 16px;
      }
      .miniMapHead{
        font-size: 11px;
        margin-bottom: 6px;
      }
      #miniSvg{
        height: 100px;
      }
      .miniMapHint{
        font-size: 9.5px;
        margin-top: 5px;
      }
      :root{ --miniMapLift: 10px; }
    }

    @media(max-width:720px) and (min-width:421px){
      :root{ --miniMapLift: 20px; }
    }

    /* ã‚¹ãƒãƒ›ã§ã®ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›æ¬„ã®èª¿æ•´ */
    @media(max-width:768px){
      .field, input[type="date"].field{
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
      }
    }

    /* ===== Modal ===== */
    .modalBack{
      position: fixed; inset:0; z-index:200;
      background: rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      padding: 18px;
    }
    .modal{
      width: min(760px, 96vw);
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.16);
      background:
        radial-gradient(600px 240px at 20% 20%, color-mix(in oklab, var(--accent1) 22%, transparent), transparent 60%),
        radial-gradient(600px 240px at 80% 35%, color-mix(in oklab, var(--accent2) 16%, transparent), transparent 62%),
        rgba(10,14,36,.80);
      box-shadow: 0 18px 70px rgba(0,0,0,.55);
      padding: 18px;
      backdrop-filter: blur(14px);
      position:relative;
      overflow:hidden;
      max-height: calc(100svh - 26px);
      overflow:auto;
    }
    .modalGlow{
      position:absolute; inset:-60px -80px;
      background:
        radial-gradient(120px 80px at 20% 30%, rgba(255,255,255,.14), rgba(255,255,255,0) 70%),
        radial-gradient(120px 80px at 70% 50%, rgba(255,255,255,.10), rgba(255,255,255,0) 70%);
      animation: modalFloat 3.6s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes modalFloat{
      0%,100%{ transform: translateY(0px); opacity:.9; }
      50%{ transform: translateY(10px); opacity:1; }
    }
    .modalTitle{margin:0; font-size:16px; letter-spacing:.06em;}
    .modalBody{margin-top:10px; font-size:13px; line-height:1.8; opacity:.92;}

    /* ===== Ascent Map (è©³ç´°) ===== */
    .ascentWrap{
      margin-top: 12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      padding: 10px;
      overflow:hidden;
      position:relative;
    }
    .ascentCaption{
      margin-top:10px;
      font-size:12px;
      line-height:1.6;
      color: rgba(234,240,255,.88);
    }
    #ascentPathProg{transition: stroke-dashoffset .38s ease;}
    .ascentPulse{animation: ascentPulse .9s ease-out 1; transform-origin:center;}
    @keyframes ascentPulse{
      0%{ transform: scale(1); }
      40%{ transform: scale(1.16); }
      100%{ transform: scale(1); }
    }
    .floaty{animation: floaty 2.8s ease-in-out infinite;}
    @keyframes floaty{0%,100%{transform:translateY(0)}50%{transform:translateY(4px)}}

    /* ç« ã‚¯ãƒªã‚¢ï¼šå…¨ä½“ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ */
    .chapterFlash{
      position: fixed; inset:0; z-index:150;
      pointer-events:none;
      opacity:0;
      background:
        radial-gradient(800px 420px at 50% 35%, color-mix(in oklab, var(--accent3) 28%, transparent), transparent 68%),
        radial-gradient(900px 520px at 50% 80%, color-mix(in oklab, var(--accent2) 18%, transparent), transparent 70%),
        rgba(255,255,255,.02);
      transition: opacity .42s ease;
    }
    .chapterFlash.on{opacity:1;}

    [hidden]{display:none !important;}
    .footer{text-align:center; margin-top:18px; font-size:12px; opacity:.78;}

    /* ä½ã„ç”»é¢ï¼ˆSEç­‰ï¼‰ã§ã•ã‚‰ã«è©°ã‚ã¦ã€Œç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¼ãƒ­ã€ã‚’ç¶­æŒ */
    @media (max-height: 740px){
      body.isQuestions .qCard{ padding: 12px; gap: 8px; }
      .qText{ font-size: 14px; line-height: 1.55; }
      .tickBtn{ padding: 8px 0; }
      .scaleWrap{ padding: 10px 10px; }
      body.isQuestions #btnResetFromQuestions{ padding: 8px 9px; }
    }
  </style>
</head>

<body>
  <div class="chapterFlash" id="chapterFlash" aria-hidden="true"></div>

  <header class="topbar" id="topbar">
    <div class="topbarInner">
      <div class="brand">
        <div class="orb" aria-hidden="true"></div>
        <div style="min-width:0;">
          <h1 class="title">FortuneAIå¼ 17ã‚¿ã‚¤ãƒ—è¨ºæ–­</h1>
          <div class="subtitle" id="topSubtitle">100å•Ã—7æ®µéšã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã€‚ç¥ç§˜ã®å·¡ç¤¼è·¯ã§ä¸Šæ˜‡</div>
        </div>
      </div>

      <div class="meter">
        <div class="waterBar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
          <div class="waterFill" id="waterFill">
            <div class="sparkles" aria-hidden="true"></div>
          </div>
        </div>
        <div class="meterText" id="meterText">0 / 100</div>
      </div>
    </div>
  </header>

  <!-- ãƒŸãƒ‹ãƒãƒƒãƒ—å¸¸æ™‚è¡¨ç¤ºï¼ˆè³ªå•ç”»é¢ã§ã®ã¿è¡¨ç¤ºãƒ»è±ªè¯ç‰ˆï¼‰ -->
  <div class="miniMapFloat" id="miniMapBtn" style="display:none;" role="button" aria-label="å·¡ç¤¼è·¯ï¼ˆè©³ç´°ï¼‰">
    <div class="miniMapHead">
      <div>ğŸ—ºï¸ å·¡ç¤¼è·¯</div>
      <div><strong id="miniPct" style="font-size:14px;">0%</strong></div>
    </div>
    <svg id="miniSvg" viewBox="0 0 320 220" width="100%" height="130" aria-hidden="true">
      <defs>
        <linearGradient id="miniStroke" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" stop-color="var(--accent1)" stop-opacity="1"/>
          <stop offset="55%" stop-color="var(--accent3)" stop-opacity="1"/>
          <stop offset="100%" stop-color="var(--accent2)" stop-opacity="1"/>
        </linearGradient>
        
        <!-- ãƒŸãƒ‹ãƒãƒƒãƒ—å°‚ç”¨ï¼šå¼·åŒ–ã‚°ãƒ­ãƒ¼ -->
        <filter id="miniGlowStrong">
          <feGaussianBlur stdDeviation="2.8" result="b"/>
          <feColorMatrix in="b" type="matrix" values="1.2 0 0 0 0  0 1.2 0 0 0  0 0 1.2 0 0  0 0 0 1 0"/>
          <feMerge>
            <feMergeNode in="b"/>
            <feMergeNode in="b"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
        
        <!-- ãƒ‘ãƒ«ã‚¹ç”¨radial gradient -->
        <radialGradient id="miniPulseGrad" cx="50%" cy="50%" r="50%">
          <stop offset="0%" stop-color="rgba(255,255,255,.95)"/>
          <stop offset="40%" stop-color="rgba(255,255,255,.50)"/>
          <stop offset="100%" stop-color="rgba(255,255,255,.05)"/>
        </radialGradient>
      </defs>
      
      <!-- èƒŒæ™¯ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ -->
      <rect x="0" y="0" width="320" height="220" fill="url(#ascentGlow)" opacity=".3"/>
      
      <!-- ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ -->
      <path id="miniPathBase"
        d="M42 190
           C 72 176, 88 172, 106 160
           C 126 146, 120 128, 140 118
           C 158 109, 166 128, 184 112
           C 202 96, 180 78, 200 68
           C 224 56, 236 84, 258 58
           C 274 38, 230 32, 196 40
           C 172 46, 168 34, 160 24"
        fill="none" stroke="rgba(255,255,255,.18)" stroke-width="7" stroke-linecap="round" stroke-linejoin="round"/>
      
      <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒ‘ã‚¹ï¼ˆå¼·åŒ–ã‚°ãƒ­ãƒ¼ï¼‰ -->
      <path id="miniPathProg"
        d="M42 190
           C 72 176, 88 172, 106 160
           C 126 146, 120 128, 140 118
           C 158 109, 166 128, 184 112
           C 202 96, 180 78, 200 68
           C 224 56, 236 84, 258 58
           C 274 38, 230 32, 196 40
           C 172 46, 168 34, 160 24"
        fill="none" stroke="url(#miniStroke)" stroke-width="7" stroke-linecap="round" stroke-linejoin="round" filter="url(#miniGlowStrong)"/>
      
      <!-- å»ºé€ ç‰©ï¼ˆãƒŸãƒ‹ç‰ˆï¼‰ -->
      <g id="miniBuildings" opacity=".90"></g>
      
      <!-- ãƒãƒ¼ã‚«ãƒ¼ï¼ˆå¼·åŒ–ç‰ˆï¼‰ -->
      <g id="miniMarker" filter="url(#miniGlowStrong)">
        <!-- ãƒ‘ãƒ«ã‚¹ãƒªãƒ³ã‚° -->
        <circle id="miniPulse" cx="42" cy="190" r="16" fill="url(#miniPulseGrad)" opacity="0">
          <animate attributeName="r" from="8" to="22" dur="1.2s" repeatCount="indefinite"/>
          <animate attributeName="opacity" from="0.6" to="0" dur="1.2s" repeatCount="indefinite"/>
        </circle>
        
        <!-- ãƒãƒ­ãƒ¼ -->
        <circle id="miniHalo" cx="42" cy="190" r="11" fill="rgba(255,255,255,.12)" stroke="rgba(255,255,255,.20)" stroke-width="1"/>
        
        <!-- ã‚³ã‚¢ãƒ‰ãƒƒãƒˆ -->
        <circle id="miniDot" cx="42" cy="190" r="6" fill="rgba(255,255,255,.98)" stroke="rgba(255,255,255,.30)" stroke-width="1.2"/>
      </g>
      
      <!-- GOALãƒãƒ¼ã‚«ãƒ¼ -->
      <g opacity=".90">
        <circle cx="160" cy="18" r="7" fill="rgba(255,255,255,.25)" stroke="rgba(255,255,255,.28)"/>
        <text x="160" y="14" text-anchor="middle" font-size="9" fill="rgba(234,240,255,.88)" style="letter-spacing:.10em; font-weight:600;">GOAL</text>
      </g>
    </svg>
    <div class="miniMapHint">ã‚¿ãƒƒãƒ—ã§è©³ç´°è¡¨ç¤º</div>
  </div>

  <div class="wrap" id="wrap">
    <section class="card" id="viewHero" style="position:relative; overflow:hidden;">
      <!-- èƒŒæ™¯è£…é£¾ -->
      <div style="position:absolute; inset:-60px -80px; pointer-events:none; opacity:.15;">
        <div style="position:absolute; top:10%; left:15%; width:180px; height:180px; border-radius:50%; background:radial-gradient(circle, var(--accent1), transparent 70%); filter:blur(40px);"></div>
        <div style="position:absolute; top:40%; right:10%; width:220px; height:220px; border-radius:50%; background:radial-gradient(circle, var(--accent2), transparent 70%); filter:blur(50px);"></div>
        <div style="position:absolute; bottom:15%; left:25%; width:200px; height:200px; border-radius:50%; background:radial-gradient(circle, var(--accent3), transparent 70%); filter:blur(45px);"></div>
      </div>
      
      <div style="position:relative; z-index:1;">
        <h2 class="h1" style="font-size:22px; margin-bottom:14px; letter-spacing:.08em;">
          FortuneAIå¼ 17ã‚¿ã‚¤ãƒ—è¨ºæ–­
        </h2>
        <p class="lead" style="font-size:14.5px; line-height:1.85; margin-bottom:18px;">
          100ã®è³ªå•ã«ç­”ãˆã‚‹ã“ã¨ã§ã€ã‚ãªãŸã®æ€§æ ¼ã‚¿ã‚¤ãƒ—ã‚’17åˆ†é¡ã§è¨ºæ–­ã—ã¾ã™ã€‚<br>
          é€²æ—ã¯ç¾ã—ã„æ°´ã®ã‚²ãƒ¼ã‚¸ã¨ç¥ç§˜çš„ãªå·¡ç¤¼è·¯ã§å¯è¦–åŒ–ã•ã‚Œã€20å•ã”ã¨ã«ç« ãŒåˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™ã€‚
        </p>
        
        <div style="margin:20px 0; padding:16px; border-radius:16px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.03);">
          <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
            <div style="width:6px; height:6px; border-radius:50%; background:var(--accent1); box-shadow:0 0 12px var(--accent1);"></div>
            <span style="font-size:13px; opacity:.92;">ã‚¹ãƒ©ã‚¤ãƒ‰æ“ä½œã§7æ®µéšè©•ä¾¡</span>
          </div>
          <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
            <div style="width:6px; height:6px; border-radius:50%; background:var(--accent3); box-shadow:0 0 12px var(--accent3);"></div>
            <span style="font-size:13px; opacity:.92;">20å•ã”ã¨ã«ç¾ã—ã„æ¼”å‡ºã¨ãƒ†ãƒ¼ãƒå¤‰åŒ–</span>
          </div>
          <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
            <div style="width:6px; height:6px; border-radius:50%; background:var(--accent2); box-shadow:0 0 12px var(--accent2);"></div>
            <span style="font-size:13px; opacity:.92;">å›ç­”å€¤ã«å¿œã˜ãŸè‰²å½©ã®å¤‰åŒ–</span>
          </div>

        </div>
        
        <div class="btnRow" style="margin-top:24px;">
          <button class="btn primary" id="btnStart" style="font-size:15px; padding:14px 24px; min-width:160px;">
            è¨ºæ–­ã‚’é–‹å§‹ã™ã‚‹
          </button>
          <button class="btn danger" id="btnResetAll">æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™ï¼ˆä¿å­˜ã‚’æ¶ˆå»ï¼‰</button>
        </div>
      </div>
    </section>

    <section class="card" id="viewProfile" hidden>
      <h2 class="h1">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h2>
      <p class="lead muted small">â€»ä¿å­˜å¾©å…ƒã‚ã‚Šã€‚userIdã¯URLï¼ˆ?userId=...ï¼‰ã§ã‚‚æ¸¡ã›ã¾ã™ã€‚ãŠåå‰ã¯ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã§ã‚‚å¯èƒ½ã§ã™</p>

      <div style="margin-top:12px;">
        <label for="name">ãŠåå‰ï¼ˆå¿…é ˆï¼‰</label>
        <input class="field" id="name" type="text" placeholder="ä¾‹ï¼šå¤ªéƒ" />
        <div class="err" id="errName">ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>

        <div style="height:12px;"></div>

        <label for="gender">æ€§åˆ¥ï¼ˆå¿…é ˆï¼‰</label>
        <select class="field" id="gender">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="male">maleï¼ˆç”·æ€§ï¼‰</option>
          <option value="female">femaleï¼ˆå¥³æ€§ï¼‰</option>
          <option value="other">otherï¼ˆãã®ä»–ï¼‰</option>
        </select>
        <div class="err" id="errGender">æ€§åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>

        <div style="height:12px;"></div>

        <label for="birthday">ç”Ÿå¹´æœˆæ—¥ï¼ˆå¿…é ˆï¼‰</label>
        <input class="field" id="birthday" type="date" />
        <div class="err" id="errBirthday">ç”Ÿå¹´æœˆæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>

        <div style="height:12px;"></div>

        <label for="userId">userIdï¼ˆä»»æ„ï¼‰</label>
        <input class="field" id="userId" type="text" placeholder="ä¾‹ï¼šUxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" />

        <div class="btnRow">
          <button class="btn ghost" id="btnBackToHero">æˆ»ã‚‹</button>
          <button class="btn primary" id="btnToQuestions">å›ç­”ã¸é€²ã‚€</button>
        </div>

        <div class="toast warn" id="profileRestoreNote" style="display:none;">
          ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ»å›ç­”ãƒ»é€²æ—ã‚’å¾©å…ƒã—ã¦ã„ã¾ã™ã€‚
        </div>
      </div>
    </section>

    <section class="card" id="viewQuestions" hidden>
      <div class="qCard">
        <div class="qTop">
          <div class="qMeta">
            <span class="chip chapterBadge" id="chapterChip">CHAPTER 1 / 5</span>
            <span class="chip" id="qIndexChip">Q 1 / 100</span>
            <span class="chip" id="qTagChip">[S+]</span>
          </div>
          <div class="qMeta">
            <span class="chip">å®Œäº† <strong id="doneCountText">0</strong></span>
          </div>
        </div>

        <div class="qText" id="qText">Q1. ï¼ˆè¨­å•ï¼‰</div>

        <div class="scaleWrap">
          <div class="scaleHead">
            <span>1 = ã¾ã£ãŸããã†æ€ã‚ãªã„</span>
            <span class="valuePill" id="valuePill">4</span>
            <span>7 = éå¸¸ã«ãã†æ€ã†</span>
          </div>

          <input id="range" class="range" type="range" min="1" max="7" step="1" value="4" />
          <div style="text-align:center; font-size:11px; opacity:.70; margin-top:6px;">ã‚¹ãƒ©ã‚¤ãƒ‰ã¾ãŸã¯ä¸‹ã®æ•°å­—ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠ</div>
          <div class="tickRow" id="tickRow"></div>
        </div>

        <div class="toast" id="qToast" style="display:none;"></div>

        <div class="sep"></div>

        <div class="btnRow">
          <button class="btn ghost" id="btnJumpProfile">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã¸æˆ»ã‚‹</button>
          <button class="btn danger" id="btnResetFromQuestions">æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™ï¼ˆä¿å­˜ã‚’æ¶ˆå»ï¼‰</button>
        </div>
      </div>
    </section>

    <section class="card" id="viewWorry" hidden>
      <h2 class="h1">æ‚©ã¿å…¥åŠ›</h2>
      <p class="lead">ä»Šæ„Ÿã˜ã¦ã„ã‚‹æ‚©ã¿ã‚’ã€2,000æ–‡å­—ä»¥å†…ã§ãã®ã¾ã¾æ›¸ã„ã¦ãã ã•ã„ã€‚ã†ã¾ãã¾ã¨ã¾ã£ã¦ã„ãªãã¦ã‚‚å¤§ä¸ˆå¤«ã§ã™ã€‚</p>
      <label for="worryText" style="margin-top:12px;">æ‚©ã¿</label>
      <textarea class="field" id="worryText" maxlength="2000" style="min-height:160px; resize:vertical; line-height:1.6;"></textarea>

      <div class="btnRow" style="justify-content:space-between;">
        <div class="muted small" id="worryCount">0 / 2000</div>
        <button class="btn primary" id="btnShowResult">çµæœã‚’è¦‹ã‚‹</button>
      </div>
    </section>

    <section class="card" id="viewResult" hidden>
      <h2 class="h1">çµæœ</h2>
      <div class="sep"></div>

      <div class="toast" id="resultToast" style="display:none;"></div>

      <div class="btnRow">
        <button class="btn primary" id="btnFinalSubmit">æœ€çµ‚é€ä¿¡ï¼ˆfinal_submitï¼‰</button>
        <button class="btn ghost" id="btnCopyJson">JSONã‚’ã‚³ãƒ”ãƒ¼</button>
        <button class="btn ghost" id="btnDownloadJson">JSONã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        <button class="btn danger" id="btnResetFromResult">æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™ï¼ˆä¿å­˜ã‚’æ¶ˆå»ï¼‰</button>
      </div>

      <div id="jsonPreviewWrap" style="display:none;">
        <div class="sep"></div>
        <p class="lead"><b>JSONãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆWEBHOOK_URLæœªè¨­å®šæ™‚ï¼‰</b></p>
        <pre class="field" id="jsonPreview" style="max-height:320px; overflow:auto; white-space:pre; font-size:11.5px; line-height:1.55;"></pre>
      </div>
    </section>

    <div class="footer">Â© FortuneAI</div>
  </div>

  <div class="bottomNav" id="bottomNav" style="display:none;">
    <div class="bottomNavInner">
      <button class="btn ghost" id="btnPrevQ">å‰ã¸</button>
      <button class="btn primary" id="btnNextQ">æ¬¡ã¸</button>
    </div>
  </div>

  <!-- ç« ã‚¯ãƒªã‚¢ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒœãƒ¼ãƒŠã‚¹/å ±é…¬æ¬„ã¯å‰Šé™¤ï¼‰ -->
  <div class="modalBack" id="chapterModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalGlow" aria-hidden="true"></div>
      <h3 class="modalTitle" id="chapterModalTitle">CHAPTER CLEAR</h3>
      <div class="modalBody" id="chapterModalBody"></div>

      <div class="btnRow" style="justify-content:flex-end;">
        <button class="btn primary" id="btnChapterContinue">æ¬¡ã®ç« ã¸</button>
      </div>
    </div>
  </div>

  <!-- å·¡ç¤¼è·¯ï¼ˆè©³ç´°ï¼‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modalBack" id="mapModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalGlow" aria-hidden="true"></div>
      <h3 class="modalTitle">ç¥ç§˜ã®å·¡ç¤¼è·¯ï¼ˆè©³ç´°ï¼‰</h3>
      <div class="modalBody" id="ascentModalBody">å›ç­”ãŒé€²ã‚€ã»ã©ã€å…‰ã®é“ãŒä¼¸ã³ã€ç²¾éœŠãŒä¸Šæ˜‡ã—ã¾ã™ã€‚20å•ã”ã¨ã«å»ºé€ ç‰©ãŒç‚¹ç¯ã—ã¾ã™ã€‚</div>

      <div class="ascentWrap">
        <svg id="ascentSvg" viewBox="0 0 320 220" width="100%" height="260" aria-label="å·¡ç¤¼è·¯">
          <defs>
            <radialGradient id="ascentGlow" cx="50%" cy="40%" r="70%">
              <stop offset="0%" stop-color="rgba(255,255,255,.12)"/>
              <stop offset="60%" stop-color="rgba(255,255,255,.03)"/>
              <stop offset="100%" stop-color="rgba(255,255,255,0)"/>
            </radialGradient>

            <linearGradient id="ascentStroke" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="var(--accent1)"/>
              <stop offset="55%" stop-color="var(--accent3)"/>
              <stop offset="100%" stop-color="var(--accent2)"/>
            </linearGradient>

            <filter id="softGlow">
              <feGaussianBlur stdDeviation="2.2" result="b"/>
              <feMerge>
                <feMergeNode in="b"/>
                <feMergeNode in="SourceGraphic"/>
              </feMerge>
            </filter>
          </defs>

          <rect x="0" y="0" width="320" height="220" fill="url(#ascentGlow)"/>

          <g opacity=".95">
            <path d="M160 18 L176 58 L160 48 L144 58 Z" fill="rgba(255,255,255,.10)" stroke="rgba(255,255,255,.16)"/>
            <circle cx="160" cy="18" r="6" fill="rgba(255,255,255,.22)" stroke="rgba(255,255,255,.22)"/>
            <text x="160" y="14" text-anchor="middle" font-size="10" fill="rgba(234,240,255,.85)" style="letter-spacing:.12em;">GOAL</text>
          </g>

          <path id="ascentPathBase"
            d="M42 190
               C 72 176, 88 172, 106 160
               C 126 146, 120 128, 140 118
               C 158 109, 166 128, 184 112
               C 202 96, 180 78, 200 68
               C 224 56, 236 84, 258 58
               C 274 38, 230 32, 196 40
               C 172 46, 168 34, 160 24"
            fill="none"
            stroke="rgba(255,255,255,.14)"
            stroke-width="6"
            stroke-linecap="round"
            stroke-linejoin="round"/>

          <path id="ascentPathProg"
            d="M42 190
               C 72 176, 88 172, 106 160
               C 126 146, 120 128, 140 118
               C 158 109, 166 128, 184 112
               C 202 96, 180 78, 200 68
               C 224 56, 236 84, 258 58
               C 274 38, 230 32, 196 40
               C 172 46, 168 34, 160 24"
            fill="none"
            stroke="url(#ascentStroke)"
            stroke-width="6"
            stroke-linecap="round"
            stroke-linejoin="round"
            filter="url(#softGlow)"/>

          <g id="ascentRunes" opacity=".95"></g>
          <g id="ascentBuildings" opacity=".98"></g>

          <g id="ascentMarker" filter="url(#softGlow)">
            <circle id="ascentHalo" cx="42" cy="190" r="10" fill="rgba(255,255,255,.10)"/>
            <circle id="ascentDot" cx="42" cy="190" r="5.5" fill="rgba(255,255,255,.92)" stroke="rgba(255,255,255,.22)"/>
            <path id="ascentWisp" class="floaty" d="M42 178 C 46 172, 54 176, 50 184 C 48 188, 44 190, 42 194 C 40 190, 36 188, 34 184 C 30 176, 38 172, 42 178 Z"
              fill="rgba(255,255,255,.18)" stroke="rgba(255,255,255,.22)"/>
          </g>

          <g id="ascentParticles" opacity=".9"></g>

          <text x="42" y="206" text-anchor="start" font-size="10" fill="rgba(234,240,255,.70)" style="letter-spacing:.12em;">START</text>
        </svg>

        <div class="ascentCaption" id="ascentCaption">ã¾ãšã¯1å•ã€‚å…‰ãŒé“ã‚’æãå§‹ã‚ã¾ã™ã€‚</div>
      </div>

      <div class="btnRow" style="justify-content:flex-end;">
        <button class="btn primary" id="btnCloseMap">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * ã“ã“ã ã‘ç·¨é›†ï¼ˆMakeã®Webhookï¼‰
     ***********************/
    const WEBHOOK_URL = "https://hook.eu2.make.com/7ac62r32ffup0cl0d1kr9h3dpbf8dz3h";
    const STORAGE_KEY = "fortuneai_17type_mystic_ascent_singlefile";

    const AXIS_MAX = 75;

    const THEMES = [
      { name:"CHAPTER 1 / 5", a1:"#7c4dff", a2:"#cfa76e", a3:"#43d3ff", bg0:"#070b1a", bg1:"#0b1231" },
      { name:"CHAPTER 2 / 5", a1:"#43d3ff", a2:"#7c4dff", a3:"#cfa76e", bg0:"#06101a", bg1:"#071a2b" },
      { name:"CHAPTER 3 / 5", a1:"#cfa76e", a2:"#43d3ff", a3:"#7c4dff", bg0:"#120c0a", bg1:"#0b1231" },
      { name:"CHAPTER 4 / 5", a1:"#ff6bd6", a2:"#43d3ff", a3:"#cfa76e", bg0:"#0d0616", bg1:"#08163a" },
      { name:"CHAPTER 5 / 5", a1:"#41d18a", a2:"#cfa76e", a3:"#7c4dff", bg0:"#060f0d", bg1:"#081a2b" },
    ];

    const TYPE_TITLES = {
      "INTJ":"FortuneAIï¼šé»’æ›œã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆï¼ˆæˆ¦ç•¥è¨­è¨ˆè€…ï¼‰",
      "INTP":"FortuneAIï¼šè’¼å¤©ã‚¢ãƒŠãƒªã‚¹ãƒˆï¼ˆåŸç†è§£å‰–è€…ï¼‰",
      "ENTJ":"FortuneAIï¼šç´…è“®ã‚³ãƒãƒ³ãƒ€ãƒ¼ï¼ˆæˆæœæŒ‡æ®è€…ï¼‰",
      "ENTP":"FortuneAIï¼šé›·å…‰ã‚¤ãƒ³ãƒ™ãƒ³ã‚¿ãƒ¼ï¼ˆå¤‰é©ç™ºæ˜è€…ï¼‰",
      "INFJ":"FortuneAIï¼šæ˜Ÿå°ã‚·ãƒ¼ã‚¢ï¼ˆæœªæ¥æ´å¯Ÿè€…ï¼‰",
      "INFP":"FortuneAIï¼šæœˆå½±ãƒãƒ¼ãƒ‰ï¼ˆç†æƒ³è©©äººï¼‰",
      "ENFJ":"FortuneAIï¼šæ—­æ—¥ãƒ¡ãƒ³ã‚¿ãƒ¼ï¼ˆè¦šé†’å°å¸«ï¼‰",
      "ENFP":"FortuneAIï¼šè™¹å½©ã‚ªãƒ©ã‚¯ãƒ«ï¼ˆå¯èƒ½æ€§ç‚¹ç«è€…ï¼‰",
      "ISTJ":"FortuneAIï¼šé‰„å¾‹ãƒãƒ¼ã‚·ãƒ£ãƒ«ï¼ˆç§©åºç›£ç£è€…ï¼‰",
      "ISFJ":"FortuneAIï¼šå®ˆç¯ã‚¹ãƒãƒ¥ãƒ¯ãƒ¼ãƒ‰ï¼ˆçŒ®èº«æ”¯æ´è€…ï¼‰",
      "ESTJ":"FortuneAIï¼šç™½é‹¼ãƒãƒ¼ã‚·ãƒ£ãƒ«ï¼ˆç¾å ´çµ±åˆ¶è€…ï¼‰",
      "ESFJ":"ç¥ç¥­ãƒ›ã‚¹ãƒˆï¼ˆèª¿å’Œæ¼”å‡ºè€…ï¼‰",
      "ISTP":"å½±åˆƒã‚¹ãƒŸã‚¹ï¼ˆå®Ÿå‹™è§£ä½“è€…ï¼‰",
      "ISFP":"èŠ±æ™¶ã‚¢ãƒ¼ãƒ†ã‚£ã‚¶ãƒ³ï¼ˆç¾æ„ŸåŒ ï¼‰",
      "ESTP":"ç–¾é¢¨ã‚¹ãƒˆãƒ©ã‚¤ã‚«ãƒ¼ï¼ˆæ©Ÿä¼šæ”»ç•¥è€…ï¼‰",
      "ESFP":"é™½å…‰ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ¼ï¼ˆæ„Ÿæƒ…èµ·å‹•è€…ï¼‰",
      "BAL":"å‡è¡¡ã‚¢ãƒ«ã‚±ãƒŸã‚¹ãƒˆï¼ˆçµ±åˆé©å¿œè€…ï¼‰"
    };

    const TAROT_MAJOR = {
      "INTJ":"éš è€…","INTP":"æ­£ç¾©","ENTJ":"çš‡å¸","ENTP":"é­”è¡“å¸«","INFJ":"å¥³æ•™çš‡","INFP":"æ˜Ÿ","ENFJ":"å¤ªé™½","ENFP":"æ„šè€…",
      "ISTJ":"æ•™çš‡","ISFJ":"ç¯€åˆ¶","ESTJ":"æˆ¦è»Š","ESFJ":"å¥³å¸","ISTP":"åŠ›","ISFP":"æ‹äºº","ESTP":"é‹å‘½ã®è¼ª","ESFP":"ä¸–ç•Œ","BAL":"å¯©åˆ¤"
    };

    /***********************
     * ç« ã‚¯ãƒªã‚¢é€šçŸ¥æ–‡ï¼ˆè¦ä»¶æº–æ‹ ï¼‰
     * - currentAnswerCount ãŒ 20,40,60,80,100 ã®ã¨ãã ã‘æ–‡ã‚’è¿”ã™
     * - ãã‚Œä»¥å¤–ã¯ç©ºæ–‡å­—
     ***********************/
    function chapterClearNotice(currentAnswerCount){
      const c = Number(currentAnswerCount);
      if (![20,40,60,80,100].includes(c)) return "";
      const n = Math.min(5, Math.ceil(c/20));

      if (c === 20)  return `ãƒãƒ£ãƒ—ã‚¿ãƒ¼${n}ã‚¯ãƒªã‚¢ã€‚20ä»¶ã®å›ç­”ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆã—è§£æåŸºç›¤ã¸åæ˜ ã—ã¾ã—ãŸã€‚æ¬¡ã¯ä¾¡å€¤è¦³ã®è¼ªéƒ­ã‚’è§£æã—ã¾ã™ã€‚`;
      if (c === 40)  return `ãƒãƒ£ãƒ—ã‚¿ãƒ¼${n}ã‚¯ãƒªã‚¢ã€‚40ä»¶ã®å…¥åŠ›ã‚’çµ±åˆã—æ¨å®šç²¾åº¦ã¸åæ˜ ã—ã¾ã—ãŸã€‚æ¬¡ã¯è¡Œå‹•å‚¾å‘ã¨æ„æ€æ±ºå®šã‚’è§£æã—ã¾ã™ã€‚`;
      if (c === 60)  return `ãƒãƒ£ãƒ—ã‚¿ãƒ¼${n}ã‚¯ãƒªã‚¢ã€‚60ä»¶ã®å›ç­”ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆã—è§£æåŸºç›¤ã¸åæ˜ ã—ã¾ã—ãŸã€‚æ¬¡ã¯å¼·ã¿ï¼å¼±ç‚¹ã¨ãƒªã‚¹ã‚¯è€æ€§ã®æ¨å®šã‚’å®Ÿè¡Œã—ã¾ã™ã€‚`;
      if (c === 80)  return `ãƒãƒ£ãƒ—ã‚¿ãƒ¼${n}ã‚¯ãƒªã‚¢ã€‚80ä»¶ã®å…¥åŠ›ã‚’çµ±åˆã—æ¨å®šãƒ¢ãƒ‡ãƒ«ã¸åæ˜ ã—ã¾ã—ãŸã€‚æ¬¡ã¯æœ€çµ‚æœ€é©åŒ–ã¨çµè«–ç”Ÿæˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚`;
      return `ãƒãƒ£ãƒ—ã‚¿ãƒ¼${n}ã‚¯ãƒªã‚¢ã€‚100ä»¶ã®å›ç­”ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆã—è§£æã‚’å®Œäº†ã—ã¾ã—ãŸã€‚æœ€çµ‚çµæœã‚’ç”Ÿæˆã—ã¾ã™ã€‚`;
    }

    /***********************
     * è¨­å•100ï¼ˆå›ºå®šï¼‰
     ***********************/
    const QUESTIONS = buildDefaultQuestions();
    function buildDefaultQuestions(){
      const out = [];
      const mk = (id, text, tag) => ({ id, text, tag });
      const E = [
        ["åˆå¯¾é¢ã®å ´ã§ã‚‚ã€è‡ªç„¶ã«è©±ã—ã‹ã‘ã‚‹ã»ã†ã ","[E+]"],
        ["ä¸€äººã§éã”ã™æ™‚é–“ãŒé•·ã„ã»ã©å®‰å¿ƒã™ã‚‹","[E-]"],
        ["äººãŒé›†ã¾ã‚‹å ´ã«è¡Œãã¨ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒæ¹§ã","[E+]"],
        ["é›‘è«‡ã‚ˆã‚Šã‚‚ã€å¿…è¦ãªä¼šè©±ã ã‘ã§ååˆ†ã ","[E-]"],
        ["ç›¸è«‡ã•ã‚Œã‚‹ã¨ã€ã™ãåå¿œã—ã¦å ´ã‚’å‹•ã‹ã—ãŸããªã‚‹","[E+]"],
        ["äºˆå®šãŒè©°ã¾ã‚‹ã¨, ã¾ãšè·é›¢ã‚’å–ã‚ŠãŸããªã‚‹","[E-]"],
        ["æ–°ã—ã„ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã«å…¥ã‚‹ã®ãŒæ¥½ã—ã¿ã ","[E+]"],
        ["è€ƒãˆã‚’ã¾ã¨ã‚ã¦ã‹ã‚‰ã§ãªã„ã¨ç™ºè¨€ã—ã«ãã„","[E-]"],
        ["äººå‰ã§è©±ã™ã“ã¨ã«æŠµæŠ—ãŒå°‘ãªã„","[E+]"],
        ["å¤§å‹¢ã®ä¸­ã«ã„ã‚‹ã‚ˆã‚Šã€å°‘äººæ•°ãŒè½ã¡ç€ã","[E-]"],
        ["å³èˆˆã§ä¼šè©±ã‚’åºƒã’ã‚‹ã®ãŒå¾—æ„ã ","[E+]"],
        ["ä¼šè©±ã®å¾Œã¯ã€ä¸€äººã§å›å¾©ã™ã‚‹æ™‚é–“ãŒå¿…è¦ã ","[E-]"],
        ["å‘¨å›²ã®ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ã«åˆã‚ã›ã¦ç››ã‚Šä¸Šã’ã‚‰ã‚Œã‚‹","[E+]"],
        ["ç™ºè¨€å‰ã«ã€é ­ã®ä¸­ã§ä½•åº¦ã‚‚ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹","[E-]"],
        ["å ´ã®ç©ºæ°—ã‚’èª­ã‚“ã§ç‡å…ˆã—ã¦å‹•ã","[E+]"],
        ["è‡ªåˆ†ã®ä¸–ç•Œã«å…¥ã‚‹æ™‚é–“ãŒãªã„ã¨æ¶ˆè€—ã™ã‚‹","[E-]"],
        ["ä»–äººã¨ä¸€ç·’ã«ä½œæ¥­ã™ã‚‹æ–¹ãŒæ—ã‚‹","[E+]"],
        ["é€£çµ¡ã¯æœ€ä½é™ã§ã„ã„ã¨æ„Ÿã˜ã‚‹","[E-]"],
        ["æ–°ã—ã„äººè„ˆä½œã‚Šã«å‰å‘ãã ","[E+]"],
        ["é™ã‹ãªç’°å¢ƒã®æ–¹ãŒé›†ä¸­ã§ãã‚‹","[E-]"],
        ["åå¿œãŒè¿”ã£ã¦ãã‚‹ã‚„ã‚Šå–ã‚ŠãŒå¥½ãã ","[E+]"],
        ["è‡ªåˆ†ã®å†…å´ã§çµè«–ãŒå‡ºã‚‹ã¾ã§è©±ã—ãŸããªã„","[E-]"],
        ["ã‚¤ãƒ™ãƒ³ãƒˆã‚„é›†ã¾ã‚Šã‚’ä¼ç”»ã™ã‚‹ã®ãŒå¥½ãã ","[E+]"],
        ["ç¤¾äº¤ã®å¾Œã¯ç–²ã‚ŒãŒã©ã£ã¨å‡ºã‚‹","[E-]"],
        ["äººã¨è©±ã™ã»ã©ã‚¢ã‚¤ãƒ‡ã‚¢ãŒå‡ºã‚‹","[E+]"],
      ];
      const S = [
        ["äº‹å®Ÿã‚„å®Ÿä¾‹ã‚’ã‚‚ã¨ã«åˆ¤æ–­ã™ã‚‹ã“ã¨ãŒå¤šã„","[S+]"],
        ["æŠ½è±¡çš„ãªå¯èƒ½æ€§ã‚’è€ƒãˆã‚‹ã®ãŒå¥½ãã ","[S-]"],
        ["ä»Šã‚ã‚‹æƒ…å ±ã‚’ä¸å¯§ã«ç¢ºèªã—ã¦é€²ã‚ãŸã„","[S+]"],
        ["ã€ã‚‚ã—ã€œãªã‚‰ã€ã®ä»®èª¬ã‚’ç«‹ã¦ã‚‹ã®ãŒæ¥½ã—ã„","[S-]"],
        ["æ‰‹é †ã‚„å…·ä½“ç­–ã‚’å›ºã‚ã‚‹ã¨å®‰å¿ƒã™ã‚‹","[S+]"],
        ["ç´°éƒ¨ã‚ˆã‚Šå…¨ä½“åƒã‚„æ„å‘³ã‚’å…ˆã«æ´ã¿ãŸã„","[S-]"],
        ["ç¾å®Ÿçš„ãªåˆ¶ç´„ã‚’è¸ã¾ãˆã¦æ±ºã‚ã‚‹","[S+]"],
        ["ç›´æ„Ÿçš„ãªã²ã‚‰ã‚ãã§æ–¹å‘æ€§ã‚’æ±ºã‚ã‚‹ã“ã¨ãŒã‚ã‚‹","[S-]"],
        ["çµŒé¨“ã«åŸºã¥ãå†ç¾æ€§ã‚’é‡è¦–ã™ã‚‹","[S+]"],
        ["æœªæ¥ã®ãƒˆãƒ¬ãƒ³ãƒ‰ã‚„æµã‚Œã‚’æƒ³åƒã—ã‚„ã™ã„","[S-]"],
        ["æ•°å­—ã‚„æ ¹æ‹ ãŒã‚ã‚‹ã¨ç´å¾—ã—ã‚„ã™ã„","[S+]"],
        ["æ›–æ˜§ã§ã‚‚ãƒ“ã‚¸ãƒ§ãƒ³ãŒã‚ã‚Œã°å‹•ã‘ã‚‹","[S-]"],
        ["å…·ä½“çš„ãªæ”¹å–„ç‚¹ã‚’åˆ—æŒ™ã§ãã‚‹","[S+]"],
        ["è±¡å¾´ã‚„æ¯”å–©ã§ç†è§£ã™ã‚‹æ–¹ãŒã—ã£ãã‚Šãã‚‹","[S-]"],
        ["ç¾å ´æ„Ÿè¦šã‚„å®Ÿå‹™ã®æ„Ÿè§¦ã‚’å¤§åˆ‡ã«ã™ã‚‹","[S+]"],
        ["ä»Šã¯ç„¡ã„å¯èƒ½æ€§ã«ãƒ¯ã‚¯ãƒ¯ã‚¯ã™ã‚‹","[S-]"],
        ["è¨ˆç”»ã¯ç¾å®Ÿã«è½ã¨ã—è¾¼ã‚ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹","[S+]"],
        ["å¸¸è­˜ã‚’ç–‘ã£ã¦æ–°ã—ã„è§£é‡ˆã‚’æ¢ã™","[S-]"],
        ["ç›®ã®å‰ã®èª²é¡Œã‚’ä¸€ã¤ãšã¤è§£ãã®ãŒå¾—æ„","[S+]"],
        ["ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚„å…±é€šç‚¹ã‚’è¦‹ã¤ã‘ã‚‹ã®ãŒå¾—æ„","[S-]"],
        ["å…·ä½“ä¾‹ãŒã‚ã‚‹ã¨ç†è§£ãŒæ—©ã„","[S+]"],
        ["ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚„ä¸–ç•Œè¦³ã‹ã‚‰ç™ºæƒ³ã™ã‚‹","[S-]"],
        ["å°ã•ãªå¤‰åŒ–ã«æ°—ã¥ãã‚„ã™ã„","[S+]"],
        ["æœ¬è³ªã‚’æ´ã‚ã°ç´°éƒ¨ã¯å¾Œã‹ã‚‰ã§ã„ã„","[S-]"],
        ["ç¾å®Ÿã®ãƒªã‚¹ã‚¯ã‚’å…ˆã«æ´—ã„å‡ºã™","[S+]"],
      ];
      const T = [
        ["çµè«–ã¯è«–ç†ã®æ•´åˆæ€§ã‚’å„ªå…ˆã—ãŸã„","[T+]"],
        ["ç›¸æ‰‹ã®æ°—æŒã¡ã‚’å„ªå…ˆã—ã¦è¨€ã„æ–¹ã‚’é¸ã¶","[T-]"],
        ["å…¬å¹³ãªãƒ«ãƒ¼ãƒ«ã«æ²¿ã£ã¦åˆ¤æ–­ã—ãŸã„","[T+]"],
        ["è¡çªã‚’é¿ã‘ã‚‹ãŸã‚ã«é…æ…®ã™ã‚‹ã“ã¨ãŒå¤šã„","[T-]"],
        ["æ„Ÿæƒ…ã‚ˆã‚Šã‚‚äº‹å®Ÿã‚’å…ˆã«æ•´ç†ã™ã‚‹","[T+]"],
        ["å ´ã®é›°å›²æ°—ã‚„äººé–“é–¢ä¿‚ã‚’é‡è¦–ã™ã‚‹","[T-]"],
        ["åŠ¹ç‡ã‚„æˆæœã‚’åŸºæº–ã«æ„æ€æ±ºå®šã™ã‚‹","[T+]"],
        ["ç›¸æ‰‹ãŒå‚·ã¤ã‹ãªã„ã“ã¨ãŒæœ€é‡è¦ã ","[T-]"],
        ["è­°è«–ã§å¼±ç‚¹ã‚’æŒ‡æ‘˜ã•ã‚Œã¦ã‚‚å†·é™ã§ã„ã‚‰ã‚Œã‚‹","[T+]"],
        ["å…±æ„Ÿã•ã‚Œã‚‹ã¨å®‰å¿ƒã™ã‚‹","[T-]"],
        ["åŸå› ã¨çµæœã‚’åˆ†è§£ã—ã¦è€ƒãˆã‚‹","[T+]"],
        ["èª°ã‹ã®åŠªåŠ›ã‚„èƒŒæ™¯ã‚’æ±²ã¿å–ã‚ŠãŸã„","[T-]"],
        ["æ­£ã—ã„/é–“é•ã„ã‚’ã¯ã£ãã‚Šã•ã›ãŸã„","[T+]"],
        ["ã€æ­£ã—ã•ã€ã‚ˆã‚Šã€ã‚„ã•ã—ã•ã€ã‚’å„ªå…ˆã™ã‚‹","[T-]"],
        ["åˆç†æ€§ãŒä½ã„ææ¡ˆã¯è¦‹ç›´ã—ãŸããªã‚‹","[T+]"],
        ["ç›¸æ‰‹ã®ç«‹å ´ã«ç«‹ã¤ã¨æ±ºã‚ãã‚Œãªã„ã“ã¨ãŒã‚ã‚‹","[T-]"],
        ["æ•°å­—ã§èª¬æ˜ã§ãã‚‹ã¨å®‰å¿ƒã™ã‚‹","[T+]"],
        ["æ„Ÿæƒ…ã®ç´å¾—æ„ŸãŒãªã„ã¨é€²ã‚ã«ãã„","[T-]"],
        ["è©•ä¾¡åŸºæº–ã‚’æ˜ç¢ºã«ã—ã¦ã‹ã‚‰å‹•ã","[T+]"],
        ["å’Œã‚’ä¹±ã•ãªã„ã‚ˆã†ã«èª¿æ•´ã™ã‚‹ã®ãŒå¾—æ„","[T-]"],
        ["é•·æœŸçš„ã«å¾—ã‹ã©ã†ã‹ã§é¸ã¶","[T+]"],
        ["é–¢ä¿‚æ€§ãŒå£Šã‚Œãã†ãªã‚‰æ–¹é‡ã‚’å¤‰ãˆã‚‹","[T-]"],
        ["æœ€é©è§£ã‚’æ¢ã™ã®ãŒå¥½ãã ","[T+]"],
        ["ç›¸æ‰‹ãŒå®‰å¿ƒã§ãã‚‹èª¬æ˜ã‚’å¿ƒãŒã‘ã‚‹","[T-]"],
        ["çµè«–ã‚’æ€¥ãŒãšæ°—æŒã¡ã‚’æ•´ãˆã‚‹æ™‚é–“ã‚‚å¿…è¦","[T-]"],
      ];
      const J = [
        ["ç· åˆ‡ã‚„è¨ˆç”»ãŒã‚ã‚‹æ–¹ãŒå‹•ãã‚„ã™ã„","[J+]"],
        ["é¸æŠè‚¢ã‚’æ®‹ã—ã¦ãŠããŸã„","[J-]"],
        ["ToDoã‚’æ•´ç†ã—ã¦é †ç•ªã«å‡¦ç†ã™ã‚‹","[J+]"],
        ["ãã®å ´ã®æµã‚Œã§æŸ”è»Ÿã«æ±ºã‚ãŸã„","[J-]"],
        ["äºˆå®šã¯æ—©ã‚ã«ç¢ºå®šã—ãŸã„","[J+]"],
        ["ç›´å‰ã¾ã§è¿·ã£ã¦æœ€è‰¯ã‚’é¸ã³ãŸã„","[J-]"],
        ["ãƒ«ãƒ¼ãƒ«ã‚„æ‰‹é †ã«æ²¿ã£ã¦é€²ã‚ãŸã„","[J+]"],
        ["å‹ã«ãƒãƒã‚‰ãšè©¦è¡ŒéŒ¯èª¤ã—ãŸã„","[J-]"],
        ["éƒ¨å±‹ã‚„ãƒ‡ãƒ¼ã‚¿ã¯æ•´ã£ã¦ã„ã‚‹æ–¹ãŒè½ã¡ç€ã","[J+]"],
        ["æ•£ã‚‰ã‹ã£ã¦ã„ã¦ã‚‚å¿…è¦ãªã‚‰ã™ãå‹•ã‘ã‚‹","[J-]"],
        ["æ±ºã‚ãŸã‚‰æœ€å¾Œã¾ã§ã‚„ã‚Šåˆ‡ã‚ŠãŸã„","[J+]"],
        ["çŠ¶æ³æ¬¡ç¬¬ã§æ–¹é‡ã‚’å¤‰ãˆã‚‹ã®ãŒè‡ªç„¶ã ","[J-]"],
        ["ã¾ãšã‚´ãƒ¼ãƒ«ã¨æœŸé™ã‚’æ±ºã‚ã‚‹","[J+]"],
        ["ã‚„ã‚ŠãªãŒã‚‰ç›®çš„ãŒå¤‰ã‚ã‚‹ã“ã¨ã‚‚ã‚ã‚‹","[J-]"],
        ["æ‰‹å¸³ã‚„ãƒ¡ãƒ¢ã§ç®¡ç†ã™ã‚‹ç¿’æ…£ãŒã‚ã‚‹","[J+]"],
        ["è¨ˆç”»ã‚ˆã‚Šã‚‚å‹¢ã„ãŒå¤§äº‹ã ã¨æ€ã†","[J-]"],
        ["ã€å®Œäº†ã€ã®çŠ¶æ…‹ã‚’ä½œã‚‹ã®ãŒå¥½ãã ","[J+]"],
        ["æœªå®Œæˆã§ã‚‚é€²ã‚ãªãŒã‚‰æ•´ãˆãŸã„","[J-]"],
        ["äºˆæƒ³å¤–ãŒèµ·ãã¦ã‚‚ãƒªã‚«ãƒãƒªè¨ˆç”»ã‚’ç«‹ã¦ã‚‹","[J+]"],
        ["é¸æŠè‚¢ãŒå¤šã„ã»ã©ãƒ¯ã‚¯ãƒ¯ã‚¯ã™ã‚‹","[J-]"],
        ["ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆãŒã‚ã‚‹ã¨å®‰å¿ƒã™ã‚‹","[J+]"],
        ["ç· åˆ‡ãŒãªã„ã¨é¢ç™½ã„æ–¹ã¸å¯„ã‚Šé“ã™ã‚‹","[J-]"],
        ["å…ˆã«æ®µå–ã‚Šã‚’æ±ºã‚ã¦ã‹ã‚‰å‹•ã","[J+]"],
        ["ãã®æ™‚ã®æ°—åˆ†ã§å„ªå…ˆé †ä½ãŒå¤‰ã‚ã‚‹","[J-]"],
        ["çµè«–ã‚’æ—©ã‚ã«å›ºã‚ã¦ã‚¹ãƒƒã‚­ãƒªã—ãŸã„","[J+]"],
      ];
      let id = 1;
      for (const [t, tag] of E) out.push(mk(id++, `Q${id-1}. ${t}`, tag));
      for (const [t, tag] of S) out.push(mk(id++, `Q${id-1}. ${t}`, tag));
      for (const [t, tag] of T) out.push(mk(id++, `Q${id-1}. ${t}`, tag));
      for (const [t, tag] of J) out.push(mk(id++, `Q${id-1}. ${t}`, tag));
      if (out.length !== 100) throw new Error("QUESTIONS must be 100");
      return out;
    }

    const $ = (id)=>document.getElementById(id);

    const dom = {
      chapterFlash:$("chapterFlash"),

      viewHero:$("viewHero"),
      viewProfile:$("viewProfile"),
      viewQuestions:$("viewQuestions"),
      viewWorry:$("viewWorry"),
      viewResult:$("viewResult"),

      btnStart:$("btnStart"),
      btnResetAll:$("btnResetAll"),

      btnBackToHero:$("btnBackToHero"),
      btnToQuestions:$("btnToQuestions"),

      name:$("name"),
      gender:$("gender"),
      birthday:$("birthday"),
      userId:$("userId"),
      errName:$("errName"),
      errGender:$("errGender"),
      errBirthday:$("errBirthday"),
      profileRestoreNote:$("profileRestoreNote"),

      qText:$("qText"),
      qTagChip:$("qTagChip"),
      qIndexChip:$("qIndexChip"),
      chapterChip:$("chapterChip"),
      doneCountText:$("doneCountText"),
      valuePill:$("valuePill"),
      range:$("range"),
      tickRow:$("tickRow"),
      qToast:$("qToast"),

      btnPrevQ:$("btnPrevQ"),
      btnNextQ:$("btnNextQ"),
      btnJumpProfile:$("btnJumpProfile"),
      btnResetFromQuestions:$("btnResetFromQuestions"),

      bottomNav:$("bottomNav"),

      worryText:$("worryText"),
      worryCount:$("worryCount"),
      btnShowResult:$("btnShowResult"),

      btnFinalSubmit:$("btnFinalSubmit"),
      btnCopyJson:$("btnCopyJson"),
      btnDownloadJson:$("btnDownloadJson"),
      btnResetFromResult:$("btnResetFromResult"),
      resultToast:$("resultToast"),
      jsonPreviewWrap:$("jsonPreviewWrap"),
      jsonPreview:$("jsonPreview"),

      waterFill:$("waterFill"),
      meterText:$("meterText"),
      topSubtitle:$("topSubtitle"),

      chapterModal:$("chapterModal"),
      chapterModalTitle:$("chapterModalTitle"),
      chapterModalBody:$("chapterModalBody"),
      btnChapterContinue:$("btnChapterContinue"),

      mapModal:$("mapModal"),
      btnCloseMap:$("btnCloseMap"),

      miniMapBtn:$("miniMapBtn"),
      miniPct:$("miniPct"),
      miniPathProg:$("miniPathProg"),
      miniHalo:$("miniHalo"),
      miniDot:$("miniDot"),
      miniPulse:$("miniPulse"),
      miniBuildings:$("miniBuildings"),

      ascentCaption:$("ascentCaption"),
      ascentPathProg:$("ascentPathProg"),
      ascentRunes:$("ascentRunes"),
      ascentBuildings:$("ascentBuildings"),
      ascentHalo:$("ascentHalo"),
      ascentDot:$("ascentDot"),
      ascentWisp:$("ascentWisp"),
      ascentParticles:$("ascentParticles"),
      ascentSvg:$("ascentSvg"),

      topbar:$("topbar"),
      wrap:$("wrap"),
    };

    const state = {
      view:"hero",
      currentIndex:0,
      profile:{ name:"", gender:"", birthday:"" },
      userId:"",
      answers:new Array(100).fill(4),
      done:new Array(100).fill(false),
      worryText:"",
      lastPayload:null,
      lastChapterShown:0
    };

    document.addEventListener("gesturestart", (e)=>e.preventDefault(), { passive:false });
    document.addEventListener("gesturechange",(e)=>e.preventDefault(), { passive:false });
    document.addEventListener("gestureend",  (e)=>e.preventDefault(), { passive:false });

    const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));

    function parseQuery(){
      const q = new URLSearchParams(location.search);
      return { userId: q.get("userId") || "" };
    }

    function save(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        view:state.view,
        currentIndex:state.currentIndex,
        profile:state.profile,
        userId:state.userId,
        answers:state.answers,
        done:state.done,
        worryText:state.worryText,
        lastChapterShown:state.lastChapterShown
      }));
    }

    function load(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return false;
      try{
        const data = JSON.parse(raw);
        if (!data || typeof data !== "object") return false;
        if (!Array.isArray(data.answers) || data.answers.length !== 100) return false;

        state.view = data.view || "hero";
        state.currentIndex = clamp(Number(data.currentIndex || 0), 0, 99);

        state.profile = {
          name: String(data.profile?.name || ""),
          gender: String(data.profile?.gender || ""),
          birthday: String(data.profile?.birthday || ""),
        };
        state.userId = String(data.userId || "");

        state.answers = data.answers.map(v => clamp(Number(v ?? 4), 1, 7));

        if (Array.isArray(data.done) && data.done.length === 100){
          state.done = data.done.map(Boolean);
        } else {
          state.done = new Array(100).fill(false);
          for (let i=0;i<state.currentIndex;i++) state.done[i] = true;
        }

        state.worryText = String(data.worryText || "");
        state.lastChapterShown = Number(data.lastChapterShown || 0);
        return true;
      }catch{
        return false;
      }
    }

    function clearAll(){
      localStorage.removeItem(STORAGE_KEY);
      state.view="hero";
      state.currentIndex=0;
      state.profile={name:"",gender:"",birthday:""};
      state.userId="";
      state.answers=new Array(100).fill(4);
      state.done=new Array(100).fill(false);
      state.worryText="";
      state.lastPayload=null;
      state.lastChapterShown=0;
      renderAll();
    }

    function setView(v){
      state.view=v;
      save();
      renderAll();
      window.scrollTo({top:0, behavior:"smooth"});
    }

    function answeredDoneCount(){
      return state.done.reduce((a,b)=>a+(b?1:0),0);
    }

    function currentChapterByDone(doneCount){
      return clamp(Math.floor(doneCount/20), 0, 4);
    }

    function applyThemeByDone(doneCount){
      const th = THEMES[currentChapterByDone(doneCount)];
      document.documentElement.style.setProperty("--accent1", th.a1);
      document.documentElement.style.setProperty("--accent2", th.a2);
      document.documentElement.style.setProperty("--accent3", th.a3);
      document.documentElement.style.setProperty("--bg0", th.bg0);
      document.documentElement.style.setProperty("--bg1", th.bg1);
      dom.chapterChip.textContent = th.name;
      dom.topSubtitle.textContent = `ç« ï¼š${th.name}ï½œå·¡ç¤¼è·¯ã§ä¸Šæ˜‡ï¼ˆ7æ®µéšï¼‰`;
    }

    function updateMeter(){
      const done = answeredDoneCount();
      const pct = (done/100)*100;
      dom.waterFill.style.width = pct.toFixed(1) + "%";
      dom.meterText.textContent = `${done} / 100`;
      dom.waterFill.parentElement.setAttribute("aria-valuenow", String(done));
      applyThemeByDone(done);
      updateAscent(done);
      updateMini(done);
    }

    function valueColor(v){
      const map = {
        1: "color-mix(in oklab, var(--accent1) 70%, black 25%)",
        2: "color-mix(in oklab, var(--accent1) 70%, var(--accent3) 20%)",
        3: "color-mix(in oklab, var(--accent3) 70%, var(--accent1) 20%)",
        4: "color-mix(in oklab, var(--accent3) 55%, rgba(255,255,255,.10) 0%)",
        5: "color-mix(in oklab, var(--accent2) 55%, var(--accent3) 30%)",
        6: "color-mix(in oklab, var(--accent2) 72%, var(--accent3) 12%)",
        7: "color-mix(in oklab, var(--accent2) 85%, white 8%)",
      };
      return map[clamp(v,1,7)];
    }

    function applyThumbScale(v){
      const dist = Math.abs(v-4);
      const t = dist/3;
      dom.range.style.setProperty("--thumbScale", String(1 + t*0.45));
    }

    function applyRangePaint(v){
      const pct = ((v-1)/6)*100;
      dom.range.style.setProperty("--fillPct", pct.toFixed(2) + "%");
      dom.range.style.setProperty("--fillColor", valueColor(v));
      dom.valuePill.textContent = String(v);
      applyThumbScale(v);

      dom.tickRow.querySelectorAll("button[data-v]").forEach(b=>{
        b.classList.toggle("on", Number(b.dataset.v) === v);
      });
    }

    function renderTicks(current){
      dom.tickRow.innerHTML = "";
      for (let v=1; v<=7; v++){
        const b = document.createElement("button");
        b.type="button";
        b.className = "tickBtn" + (v===current ? " on" : "");
        b.textContent = String(v);
        b.dataset.v = String(v);
        b.addEventListener("click", ()=> setAnswerValue(v, true));
        dom.tickRow.appendChild(b);
      }
    }

    function setAnswerValue(v, markDone){
      const i = state.currentIndex;
      const val = clamp(Number(v),1,7);
      state.answers[i] = val;
      if (markDone) state.done[i] = true;
      save();
      dom.range.value = String(val);
      applyRangePaint(val);
      dom.doneCountText.textContent = String(answeredDoneCount());
      updateMeter();
    }

    function validateProfile(){
      let ok = true;
      dom.errName.style.display="none";
      dom.errGender.style.display="none";
      dom.errBirthday.style.display="none";
      if (!dom.name.value.trim()){ dom.errName.style.display="block"; ok=false; }
      if (!dom.gender.value){ dom.errGender.style.display="block"; ok=false; }
      if (!dom.birthday.value){ dom.errBirthday.style.display="block"; ok=false; }
      return ok;
    }

    function syncProfileFromInputs(){
      state.profile.name = dom.name.value.trim();
      state.profile.gender = dom.gender.value;
      state.profile.birthday = dom.birthday.value;
      state.userId = dom.userId.value.trim();
      save();
    }

    function answerToValue(ans){ return (Number(ans) - 4); }

    function applyTagToAxis(tag, val, scores){
      const m = String(tag).match(/\[([ESTJ])([+-])\]/);
      if (!m) return;
      const axis = m[1];
      const sign = m[2];
      const v = (sign === "+") ? val : -val;
      if (axis==="E") scores.E += v;
      if (axis==="S") scores.S += v;
      if (axis==="T") scores.T += v;
      if (axis==="J") scores.J += v;
    }

    function computeScores(){
      const scores = {E:0,S:0,T:0,J:0};
      for (let i=0;i<100;i++){
        const val = answerToValue(state.answers[i]);
        applyTagToAxis(QUESTIONS[i].tag, val, scores);
      }
      scores.E = clamp(scores.E, -AXIS_MAX, AXIS_MAX);
      scores.S = clamp(scores.S, -AXIS_MAX, AXIS_MAX);
      scores.T = clamp(scores.T, -AXIS_MAX, AXIS_MAX);
      scores.J = clamp(scores.J, -AXIS_MAX, AXIS_MAX);
      return scores;
    }

    function computeType(scores){
      const absE = Math.abs(scores.E), absS=Math.abs(scores.S), absT=Math.abs(scores.T), absJ=Math.abs(scores.J);
      const isBAL = (absE < 8 && absS < 8 && absT < 8 && absJ < 8);
      if (isBAL) return { typeCode:"BAL", isBAL:true };
      const EorI = (scores.E >= 0) ? "E" : "I";
      const SorN = (scores.S >= 0) ? "S" : "N";
      const TorF = (scores.T >= 0) ? "T" : "F";
      const JorP = (scores.J >= 0) ? "J" : "P";
      return { typeCode: (EorI+SorN+TorF+JorP), isBAL:false };
    }

    function buildPayload(){
      const payload = {
        action:"final_submit",
        userId: (state.userId || "").trim(),
        step:999,
        profile:{
          gender: state.profile.gender,
          name: state.profile.name,
          birthday: state.profile.birthday
        },
        answers: state.answers.map(v => Number(v)),
        worryText: state.worryText || ""
      };
      if (!payload.profile.name || !payload.profile.gender || !payload.profile.birthday) throw new Error("profile incomplete");
      if (!Array.isArray(payload.answers) || payload.answers.length !== 100) throw new Error("answers invalid");
      for (const a of payload.answers){
        if (!Number.isInteger(a) || a<1 || a>7) throw new Error("answers must be 1..7 integers");
      }
      if (payload.worryText.length > 2000) payload.worryText = payload.worryText.slice(0,2000);
      return payload;
    }

    function safeJson(obj){ return JSON.stringify(obj, null, 2); }

    async function copyToClipboard(text){
      try{ await navigator.clipboard.writeText(text); return true; }
      catch{
        const ta = document.createElement("textarea");
        ta.value=text; ta.style.position="fixed"; ta.style.left="-9999px";
        document.body.appendChild(ta); ta.focus(); ta.select();
        let ok=false; try{ ok=document.execCommand("copy"); }catch{ ok=false; }
        ta.remove(); return ok;
      }
    }

    function downloadText(filename, text){
      const blob = new Blob([text], {type:"application/json;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href=url; a.download=filename;
      document.body.appendChild(a);
      a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    async function finalSubmit(){
      dom.resultToast.style.display="none";
      let payload;
      try{ payload = buildPayload(); }
      catch(e){
        dom.resultToast.className="toast bad";
        dom.resultToast.textContent="é€ä¿¡å‰ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸï¼š " + (e?.message || e);
        dom.resultToast.style.display="block";
        return;
      }
      state.lastPayload = payload;
      save();

      const jsonText = safeJson(payload);

      if (!WEBHOOK_URL){
        dom.jsonPreviewWrap.style.display="block";
        dom.jsonPreview.textContent = jsonText;
        dom.resultToast.className="toast warn";
        dom.resultToast.textContent="WEBHOOK_URLæœªè¨­å®šã®ãŸã‚é€ä¿¡ã›ãšã€JSONã‚’è¡¨ç¤ºã—ã¾ã—ãŸã€‚";
        dom.resultToast.style.display="block";
        return;
      }

      dom.resultToast.className="toast";
      dom.resultToast.textContent="é€ä¿¡ä¸­â€¦";
      dom.resultToast.style.display="block";

      try{
        const res = await fetch(WEBHOOK_URL, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: jsonText
        });
        if (!res.ok){
          const body = await res.text().catch(()=> "");
          dom.resultToast.className="toast bad";
          dom.resultToast.textContent=`é€ä¿¡å¤±æ•—ï¼šHTTP ${res.status}\n${body ? body.slice(0,400) : ""}`;
          return;
        }
        const body = await res.text().catch(()=> "");
        dom.resultToast.className="toast ok";
        dom.resultToast.textContent=`é€ä¿¡æˆåŠŸï¼šHTTP ${res.status}\n${body ? body.slice(0,400) : ""}`;
      }catch(e){
        dom.resultToast.className="toast bad";
        dom.resultToast.textContent="é€ä¿¡ã‚¨ãƒ©ãƒ¼ï¼š " + (e?.message || e);
      }
    }

    /***********************
     * å·¡ç¤¼è·¯ï¼ˆé€²æ—ã§ä¸Šæ˜‡ï¼‰ï¼‹å»ºç‰©ï¼ˆ20å•ã”ã¨ï¼‰
     ***********************/
    const ascent = { pathLen:0, lastDone:0, raf:0, particles:[] };
    const mini = { pathLen:0 };

    function initAscent(){
      ascent.pathLen = dom.ascentPathProg.getTotalLength();
      dom.ascentPathProg.style.strokeDasharray = `${ascent.pathLen} ${ascent.pathLen}`;
      dom.ascentPathProg.style.strokeDashoffset = `${ascent.pathLen}`;

      mini.pathLen = dom.miniPathProg.getTotalLength();
      dom.miniPathProg.style.strokeDasharray = `${mini.pathLen} ${mini.pathLen}`;
      dom.miniPathProg.style.strokeDashoffset = `${mini.pathLen}`;

      renderAscentRunes();
      renderAscentBuildings();
      renderMiniBuildings();
      seedAscentParticles(22);
      cancelAnimationFrame(ascent.raf);
      ascent.raf = requestAnimationFrame(ascentAnimate);
    }

    function renderAscentRunes(){
      dom.ascentRunes.innerHTML = "";
      for (let n=5; n<=100; n+=5){
        const t = n/100;
        const pt = dom.ascentPathProg.getPointAtLength(ascent.pathLen*t);

        const g = document.createElementNS("http://www.w3.org/2000/svg","g");
        g.setAttribute("data-node", String(n));
        const is20 = (n%20===0), is10=(n%10===0);

        if (is20){
          const ring = document.createElementNS("http://www.w3.org/2000/svg","circle");
          ring.setAttribute("cx", pt.x); ring.setAttribute("cy", pt.y);
          ring.setAttribute("r", 10);
          ring.setAttribute("fill","rgba(255,255,255,.06)");
          ring.setAttribute("stroke","rgba(255,255,255,.20)");
          ring.setAttribute("stroke-width","1.2");
          g.appendChild(ring);
        } else if (is10){
          const diamond = document.createElementNS("http://www.w3.org/2000/svg","path");
          diamond.setAttribute("d", `M ${pt.x} ${pt.y-6} L ${pt.x+6} ${pt.y} L ${pt.x} ${pt.y+6} L ${pt.x-6} ${pt.y} Z`);
          diamond.setAttribute("fill","rgba(255,255,255,.06)");
          diamond.setAttribute("stroke","rgba(255,255,255,.16)");
          g.appendChild(diamond);
        } else {
          const dot = document.createElementNS("http://www.w3.org/2000/svg","circle");
          dot.setAttribute("cx", pt.x); dot.setAttribute("cy", pt.y);
          dot.setAttribute("r", 3.6);
          dot.setAttribute("fill","rgba(255,255,255,.06)");
          dot.setAttribute("stroke","rgba(255,255,255,.14)");
          g.appendChild(dot);
        }

        dom.ascentRunes.appendChild(g);
      }
    }

    function renderAscentBuildings(){
      dom.ascentBuildings.innerHTML = "";
      const milestones = [20,40,60,80,100];
      milestones.forEach(m=>{
        const t = m/100;
        const pt = dom.ascentPathProg.getPointAtLength(ascent.pathLen*t);

        const g = document.createElementNS("http://www.w3.org/2000/svg","g");
        g.setAttribute("data-b", String(m));
        g.setAttribute("class","floaty");

        const idx = Math.min(4, Math.floor((m-1)/20));
        const color = ["rgba(255,255,255,.16)","rgba(255,255,255,.14)","rgba(255,255,255,.16)","rgba(255,255,255,.14)","rgba(255,255,255,.18)"][idx];

        const base = document.createElementNS("http://www.w3.org/2000/svg","path");
        base.setAttribute("d", `M ${pt.x-8} ${pt.y+10} L ${pt.x+8} ${pt.y+10} L ${pt.x+6} ${pt.y+18} L ${pt.x-6} ${pt.y+18} Z`);
        base.setAttribute("fill","rgba(0,0,0,.18)");
        base.setAttribute("stroke", color);
        base.setAttribute("stroke-width","1.1");
        g.appendChild(base);

        const spire = document.createElementNS("http://www.w3.org/2000/svg","path");
        spire.setAttribute("d", `M ${pt.x} ${pt.y-16} L ${pt.x+10} ${pt.y+10} L ${pt.x} ${pt.y+4} L ${pt.x-10} ${pt.y+10} Z`);
        spire.setAttribute("fill","rgba(255,255,255,.06)");
        spire.setAttribute("stroke", color);
        spire.setAttribute("stroke-width","1.1");
        g.appendChild(spire);

        const gem = document.createElementNS("http://www.w3.org/2000/svg","circle");
        gem.setAttribute("cx", pt.x);
        gem.setAttribute("cy", pt.y-16);
        gem.setAttribute("r", 3.8);
        gem.setAttribute("fill", "rgba(255,255,255,.28)");
        gem.setAttribute("stroke", "rgba(255,255,255,.22)");
        g.appendChild(gem);

        dom.ascentBuildings.appendChild(g);
      });
    }

    function renderMiniBuildings(){
      dom.miniBuildings.innerHTML = "";
      const milestones = [20,40,60,80,100];
      milestones.forEach(m=>{
        const t = m/100;
        const pt = dom.miniPathProg.getPointAtLength(mini.pathLen*t);

        const g = document.createElementNS("http://www.w3.org/2000/svg","g");
        g.setAttribute("data-mb", String(m));

        const idx = Math.min(4, Math.floor((m-1)/20));
        const colors = [
          "color-mix(in oklab, var(--accent1) 60%, white 10%)",
          "color-mix(in oklab, var(--accent3) 60%, white 10%)",
          "color-mix(in oklab, var(--accent2) 60%, white 10%)",
          "color-mix(in oklab, var(--accent1) 65%, var(--accent3) 20%)",
          "color-mix(in oklab, var(--accent2) 70%, white 15%)"
        ];
        const color = colors[idx];

        // ãƒŸãƒ‹å»ºé€ ç‰©ï¼ˆå°ã•ã‚ãƒ»ã‚·ãƒ³ãƒ—ãƒ«ï¼‰
        const building = document.createElementNS("http://www.w3.org/2000/svg","path");
        building.setAttribute("d", `M ${pt.x} ${pt.y-6} L ${pt.x+4} ${pt.y+4} L ${pt.x} ${pt.y+2} L ${pt.x-4} ${pt.y+4} Z`);
        building.setAttribute("fill", "rgba(255,255,255,.08)");
        building.setAttribute("stroke", color);
        building.setAttribute("stroke-width","1.2");
        g.appendChild(building);

        const gem = document.createElementNS("http://www.w3.org/2000/svg","circle");
        gem.setAttribute("cx", pt.x);
        gem.setAttribute("cy", pt.y-6);
        gem.setAttribute("r", 2.2);
        gem.setAttribute("fill", color);
        gem.setAttribute("stroke", "rgba(255,255,255,.30)");
        gem.setAttribute("stroke-width", "0.8");
        g.appendChild(gem);

        dom.miniBuildings.appendChild(g);
      });
    }

    function seedAscentParticles(k){
      ascent.particles = [];
      for (let i=0;i<k;i++){
        ascent.particles.push({
          x: 40 + Math.random()*240,
          y: 30 + Math.random()*170,
          r: 1.2 + Math.random()*2.1,
          a: 0.22 + Math.random()*0.35,
          ph: Math.random()*Math.PI*2
        });
      }
      drawAscentParticles(0);
    }

    function drawAscentParticles(time){
      dom.ascentParticles.innerHTML = "";
      for (const p of ascent.particles){
        const yy = p.y + Math.sin(time*0.0012 + p.ph) * 6;
        const xx = p.x + Math.cos(time*0.0010 + p.ph) * 6;
        const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
        c.setAttribute("cx", xx.toFixed(2));
        c.setAttribute("cy", yy.toFixed(2));
        c.setAttribute("r", p.r.toFixed(2));
        c.setAttribute("fill", "rgba(255,255,255,.65)");
        c.setAttribute("opacity", p.a.toFixed(2));
        dom.ascentParticles.appendChild(c);
      }
    }

    function ascentAnimate(t){
      drawAscentParticles(t);
      dom.ascentHalo.setAttribute("opacity", String(0.22 + 0.06*Math.sin(t*0.003)));
      ascent.raf = requestAnimationFrame(ascentAnimate);
    }

    function updateAscent(doneCount){
      const pct = doneCount/100;
      const offset = ascent.pathLen * (1 - pct);
      dom.ascentPathProg.style.strokeDashoffset = String(offset);

      const pt = dom.ascentPathProg.getPointAtLength(ascent.pathLen * pct);
      dom.ascentHalo.setAttribute("cx", pt.x);
      dom.ascentHalo.setAttribute("cy", pt.y);
      dom.ascentDot.setAttribute("cx", pt.x);
      dom.ascentDot.setAttribute("cy", pt.y);

      dom.ascentWisp.setAttribute("transform", `translate(${(pt.x-42).toFixed(2)}, ${(pt.y-190).toFixed(2)})`);

      dom.ascentRunes.querySelectorAll("g[data-node]").forEach(g=>{
        const n = Number(g.getAttribute("data-node"));
        const on = (doneCount >= n);
        g.style.opacity = on ? "1" : ".45";
        g.style.filter = on ? "url(#softGlow)" : "none";
      });

      dom.ascentBuildings.querySelectorAll("g[data-b]").forEach(g=>{
        const m = Number(g.getAttribute("data-b"));
        const on = (doneCount >= m);
        g.style.opacity = on ? "1" : ".28";
        g.style.filter = on ? "url(#softGlow)" : "none";
      });

      let cap = "ã¾ãšã¯1å•ã€‚å…‰ãŒé“ã‚’æãå§‹ã‚ã¾ã™ã€‚";
      if (doneCount >= 10) cap = "å·¡ç¤¼è·¯ãŒè¦‹ãˆã¦ãã¾ã—ãŸã€‚";
      if (doneCount >= 20) cap = "ç¬¬1ç« åˆ°é”ã€‚è§£æãƒ†ãƒ¼ãƒãŒæ›´æ–°ã•ã‚Œã¾ã™ã€‚";
      if (doneCount >= 50) cap = "åŠåˆ†åˆ°é”ã€‚";
      if (doneCount >= 80) cap = "æ®‹ã‚Šã‚ãšã‹ã€‚";
      if (doneCount >= 100) cap = "åˆ°é”ã€‚çµæœã‚’çµ±åˆã—ã¾ã™ã€‚";
      dom.ascentCaption.textContent = cap;

      if (doneCount > ascent.lastDone){
        dom.ascentDot.classList.remove("ascentPulse");
        void dom.ascentDot.offsetWidth;
        dom.ascentDot.classList.add("ascentPulse");
        ascent.lastDone = doneCount;
        try{ navigator.vibrate?.([18]); }catch{}
      }
    }

    function updateMini(doneCount){
      const pct = doneCount/100;
      const offset = mini.pathLen * (1 - pct);
      dom.miniPathProg.style.strokeDashoffset = String(offset);
      dom.miniPct.textContent = `${Math.round(pct*100)}%`;

      const pt = dom.miniPathProg.getPointAtLength(mini.pathLen * pct);
      dom.miniHalo.setAttribute("cx", pt.x);
      dom.miniHalo.setAttribute("cy", pt.y);
      dom.miniDot.setAttribute("cx", pt.x);
      dom.miniDot.setAttribute("cy", pt.y);
      dom.miniPulse.setAttribute("cx", pt.x);
      dom.miniPulse.setAttribute("cy", pt.y);

      // å»ºé€ ç‰©ã®ç‚¹ç¯çŠ¶æ…‹ã‚’æ›´æ–°
      dom.miniBuildings.querySelectorAll("g[data-mb]").forEach(g=>{
        const m = Number(g.getAttribute("data-mb"));
        const on = (doneCount >= m);
        g.style.opacity = on ? "1" : ".28";
        g.style.filter = on ? "url(#miniGlowStrong)" : "none";
      });
    }

    function flashChapter(){
      dom.chapterFlash.classList.add("on");
      setTimeout(()=> dom.chapterFlash.classList.remove("on"), 420);
    }

    function maybeShowChapterClear(){
      const done = answeredDoneCount();

      // â˜…é€šçŸ¥æ–‡ï¼šæ¡ä»¶å¤–ã¯ç©ºæ–‡å­—ï¼ˆ=è¡¨ç¤ºã—ãªã„ï¼‰
      const notice = chapterClearNotice(done);
      if (!notice) return;

      // â˜…åŒã˜åˆ°é”ç‚¹ã§ã®å†è¡¨ç¤ºã‚’é˜²ã
      if (state.lastChapterShown >= done) return;
      state.lastChapterShown = done;
      save();

      flashChapter();

      dom.chapterModalTitle.textContent = `CHAPTER CLEARï¼ˆ${done}/100ï¼‰`;
      dom.chapterModalBody.textContent = notice;

      // 100åˆ°é”æ™‚ã ã‘ãƒœã‚¿ãƒ³æ–‡è¨€ã‚’å¤‰ãˆã‚‹ï¼ˆä»»æ„ï¼‰
      dom.btnChapterContinue.textContent = (done === 100) ? "çµæœã¸é€²ã‚€" : "æ¬¡ã®ç« ã¸";

      dom.chapterModal.style.display = "flex";
      dom.chapterModal.setAttribute("aria-hidden","false");
      try{ navigator.vibrate?.([25, 45, 25]); }catch{}
    }

    function closeChapterModal(){
      dom.chapterModal.style.display = "none";
      dom.chapterModal.setAttribute("aria-hidden","true");
      updateMeter();

      // 100ãªã‚‰çµæœã¸ï¼ˆä»»æ„ï¼‰
      if (answeredDoneCount() >= 100 && state.view === "questions"){
        setView("worry");
      }
    }

    function openMapModal(){
      dom.mapModal.style.display = "flex";
      dom.mapModal.setAttribute("aria-hidden","false");
      updateMeter();
    }
    function closeMapModal(){
      dom.mapModal.style.display = "none";
      dom.mapModal.setAttribute("aria-hidden","true");
    }

    function hideAllViews(){
      dom.viewHero.hidden=true;
      dom.viewProfile.hidden=true;
      dom.viewQuestions.hidden=true;
      dom.viewWorry.hidden=true;
      dom.viewResult.hidden=true;
    }

    function renderProfile(){
      dom.name.value = state.profile.name || "";
      dom.gender.value = state.profile.gender || "";
      dom.birthday.value = state.profile.birthday || "";
      dom.userId.value = state.userId || "";
    }

    function renderQuestion(){
      const i = state.currentIndex;
      const q = QUESTIONS[i];
      dom.qText.textContent = q.text;
      dom.qTagChip.textContent = q.tag; // è¡¨ç¤ºã¯CSSã§éè¡¨ç¤º
      dom.qIndexChip.textContent = `Q ${i+1} / 100`;

      const done = answeredDoneCount();
      dom.doneCountText.textContent = String(done);

      const current = Number.isInteger(state.answers[i]) ? state.answers[i] : 4;
      dom.range.value = String(current);
      renderTicks(current);
      applyRangePaint(current);

      dom.btnPrevQ.disabled = (i===0);
      dom.btnNextQ.textContent = (i===99) ? "æ¬¡ã¸ï¼ˆæ‚©ã¿å…¥åŠ›ï¼‰" : "æ¬¡ã¸";
    }

    function updateWorryCount(){
      const len = dom.worryText.value.length;
      dom.worryCount.textContent = `${len} / 2000`;
    }

    function renderWorry(){
      dom.worryText.value = state.worryText || "";
      updateWorryCount();
    }

    function renderResult(){
      dom.resultToast.style.display="none";
      dom.jsonPreviewWrap.style.display="none";

      let payload;
      try{ payload = buildPayload(); state.lastPayload = payload; save(); }
      catch(e){
        dom.resultToast.className="toast bad";
        dom.resultToast.textContent="çµæœè¡¨ç¤ºå‰ã®ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸï¼š " + (e?.message || e);
        dom.resultToast.style.display="block";
        return;
      }

      const scores = computeScores();
      const t = computeType(scores);
      const code = t.typeCode;

      const title = TYPE_TITLES[code] || "ï¼ˆæœªå®šç¾©ï¼‰";
      const tarot = TAROT_MAJOR[code] || "â€”";

      dom.resultToast.className="toast ok";
      dom.resultToast.textContent = `åˆ¤å®šï¼š${code}\n${title}\nï¼ˆè±¡å¾´ï¼‰ã‚¿ãƒ­ãƒƒãƒˆï¼š${tarot}\n\nã“ã®ã¾ã¾æœ€çµ‚é€ä¿¡ã§ãã¾ã™ã€‚`;
      dom.resultToast.style.display="block";
    }

    function setBodyMode(){
      const inQuestions = (state.view==="questions");
      document.body.classList.toggle("isQuestions", inQuestions);
      recalcLayoutVars();
    }

    function recalcLayoutVars(){
      const headerH = dom.topbar?.offsetHeight || 110;
      const bottomH = (dom.bottomNav?.style.display !== "none") ? (dom.bottomNav?.offsetHeight || 86) : 0;
      document.documentElement.style.setProperty("--headerH", headerH + "px");
      document.documentElement.style.setProperty("--bottomH", bottomH + "px");
    }

    function renderAll(){
      hideAllViews();

      const inQuestions = (state.view==="questions");
      dom.bottomNav.style.display = inQuestions ? "block" : "none";
      dom.miniMapBtn.style.display = inQuestions ? "block" : "none";

      if (state.view==="hero"){ dom.viewHero.hidden=false; }
      if (state.view==="profile"){ dom.viewProfile.hidden=false; renderProfile(); }
      if (state.view==="questions"){ dom.viewQuestions.hidden=false; renderQuestion(); }
      if (state.view==="worry"){ dom.viewWorry.hidden=false; renderWorry(); }
      if (state.view==="result"){ dom.viewResult.hidden=false; renderResult(); }

      setBodyMode();
      updateMeter();

      requestAnimationFrame(recalcLayoutVars);
    }

    dom.btnStart.addEventListener("click", ()=> setView("profile"));
    dom.btnResetAll.addEventListener("click", clearAll);
    dom.btnBackToHero.addEventListener("click", ()=> setView("hero"));

    dom.btnToQuestions.addEventListener("click", ()=>{
      if (!validateProfile()) return;
      syncProfileFromInputs();
      setView("questions");
    });

    dom.name.addEventListener("input", syncProfileFromInputs);
    dom.gender.addEventListener("change", syncProfileFromInputs);
    dom.birthday.addEventListener("change", syncProfileFromInputs);
    dom.userId.addEventListener("input", syncProfileFromInputs);

    dom.btnResetFromQuestions.addEventListener("click", clearAll);
    dom.btnResetFromResult.addEventListener("click", clearAll);

    dom.btnJumpProfile.addEventListener("click", ()=> setView("profile"));

    dom.range.addEventListener("input", ()=>{
      const v = clamp(Number(dom.range.value),1,7);
      setAnswerValue(v, true);
    });

    dom.btnPrevQ.addEventListener("click", ()=>{
      if (state.currentIndex>0){
        state.currentIndex--;
        save();
        renderQuestion();
        updateMeter();
      }
    });

    dom.btnNextQ.addEventListener("click", ()=>{
      const i = state.currentIndex;
      state.done[i] = true;

      if (i === 99){
        save(); updateMeter(); maybeShowChapterClear();
        setView("worry");
        return;
      }
      state.currentIndex++;
      save();
      renderQuestion();
      updateMeter();
      maybeShowChapterClear();
    });

    dom.btnChapterContinue.addEventListener("click", closeChapterModal);
    dom.chapterModal.addEventListener("click", (e)=>{ if (e.target===dom.chapterModal) closeChapterModal(); });

    // ãƒŸãƒ‹ãƒãƒƒãƒ—ï¼šã‚¯ãƒªãƒƒã‚¯ã¨ã‚¿ãƒƒãƒã®ä¸¡æ–¹ã«å¯¾å¿œ
    dom.miniMapBtn.addEventListener("click", (e)=>{
      e.preventDefault();
      e.stopPropagation();
      openMapModal();
    });
    dom.miniMapBtn.addEventListener("touchend", (e)=>{
      e.preventDefault();
      e.stopPropagation();
      openMapModal();
    }, { passive: false });
    
    dom.btnCloseMap.addEventListener("click", closeMapModal);
    dom.mapModal.addEventListener("click", (e)=>{ if (e.target===dom.mapModal) closeMapModal(); });

    dom.worryText.addEventListener("input", ()=>{
      state.worryText = dom.worryText.value.slice(0,2000);
      updateWorryCount();
      save();
    });

    dom.btnShowResult.addEventListener("click", ()=> setView("result"));
    dom.btnFinalSubmit.addEventListener("click", finalSubmit);

    dom.btnCopyJson.addEventListener("click", async ()=>{
      let payload = state.lastPayload;
      if (!payload){
        try{ payload = buildPayload(); state.lastPayload = payload; save(); }
        catch(e){
          dom.resultToast.className="toast bad";
          dom.resultToast.textContent="JSONç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸï¼š " + (e?.message || e);
          dom.resultToast.style.display="block";
          return;
        }
      }
      const ok = await copyToClipboard(safeJson(payload));
      dom.resultToast.className = "toast " + (ok ? "ok" : "bad");
      dom.resultToast.textContent = ok ? "JSONã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚" : "ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
      dom.resultToast.style.display="block";
    });

    dom.btnDownloadJson.addEventListener("click", ()=>{
      let payload = state.lastPayload;
      if (!payload){
        try{ payload = buildPayload(); state.lastPayload = payload; save(); }
        catch(e){
          dom.resultToast.className="toast bad";
          dom.resultToast.textContent="JSONç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸï¼š " + (e?.message || e);
          dom.resultToast.style.display="block";
          return;
        }
      }
      downloadText("fortuneai_final_submit.json", safeJson(payload));
      dom.resultToast.className="toast ok";
      dom.resultToast.textContent="JSONã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚";
      dom.resultToast.style.display="block";
    });

    window.addEventListener("resize", ()=>{ recalcLayoutVars(); });

    /***********************
     * Boot
     ***********************/
    (function init(){
      const q = parseQuery();
      if (q.userId) state.userId = q.userId;

      const restored = load();
      if (restored){
        if (q.userId) state.userId = q.userId;
        dom.profileRestoreNote.style.display="block";
        setTimeout(()=> dom.profileRestoreNote.style.display="none", 2500);
      }

      initAscent();
      renderAll();
      recalcLayoutVars();
      requestAnimationFrame(recalcLayoutVars);
    })();
  </script>
</body>
</html>
